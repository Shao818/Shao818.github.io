<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="倾向得分匹配法（PSM）, R,Stata等">
    <meta name="description" content="本网站是个人兴趣爱好，总结分享经验，记录生活点滴的平台，希望在以后的学习旅途中，走出自己的风景。">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>倾向得分匹配法（PSM） | 王芍</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">

    <script src="/libs/jquery/jquery.min.js"></script>

<!-- hexo injector head_end start -->
<link rel="stylesheet" href="/custom_css_source.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 5.2.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
<link rel="alternate" href="/atom.xml" title="王芍" type="application/atom+xml">
</head>




<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">王芍</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>留言板</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友情链接</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">王芍</div>
        <div class="logo-desc">
            
            本网站是个人兴趣爱好，总结分享经验，记录生活点滴的平台，希望在以后的学习旅途中，走出自己的风景。
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			留言板
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友情链接
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/Shao818" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/Shao818" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    
<script src="/libs/cryptojs/crypto-js.min.js"></script>
<script>
    (function() {
        let pwd = 'f79890d05fd23989cb38891a44017345f7a170825fcb1dfef24fe431fded8ca0';
        if (pwd && pwd.length > 0) {
            if (pwd !== CryptoJS.SHA256(prompt('请输入访问本文章的密码')).toString(CryptoJS.enc.Hex)) {
                alert('密码错误，将返回主页！');
                location.href = '/';
            }
        }
    })();
</script>




<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/8.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">倾向得分匹配法（PSM）</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        padding: 35px 0 15px 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        padding-bottom: 30px;
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/%E8%AE%A1%E9%87%8F%E7%BB%8F%E6%B5%8E%E5%AD%A6/">
                                <span class="chip bg-color">计量经济学</span>
                            </a>
                        
                            <a href="/tags/PSM/">
                                <span class="chip bg-color">PSM</span>
                            </a>
                        
                            <a href="/tags/%E5%80%BE%E5%90%91%E5%BE%97%E5%88%86%E5%8C%B9%E9%85%8D%E6%B3%95/">
                                <span class="chip bg-color">倾向得分匹配法</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/%E8%AE%A1%E9%87%8F%E7%BB%8F%E6%B5%8E%E5%AD%A6/" class="post-category">
                                计量经济学
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2020-12-06
                </div>
                

                

                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    68 分
                </div>
                

                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">

        
        <!-- 是否加载使用自带的 prismjs. -->
        <link rel="stylesheet" href="/libs/prism/prism.css">
        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="stata手动各类匹配方法大全-a理论篇">Stata手动：各类匹配方法大全 A——理论篇</h1>
<blockquote>
<p>匹配是研究处理效应的常见工具，本文总结了常见的匹配方法，并在第三部分给出 Stata 模拟以比较不同的匹配方法的优劣。</p>
</blockquote>
<h2 id="单变量匹配-uni-variate-match">单变量匹配 uni-variate match</h2>
<p>单变量匹配的方法有精确匹配、粗糙精确匹配，k-近邻匹配和半径 (卡尺) 匹配。</p>
<h3 id="精确匹配-exact-match">精确匹配 exact match</h3>
<p>顾名思义，当且仅当两个观测值的匹配变量相等时匹配成功。</p>
<h3 id="粗糙精确匹配-coarsened-exact-match">粗糙精确匹配 coarsened exact match</h3>
<p>粗糙精确匹配用途广泛，通常要求匹配变量是分类变量。比如公司金融中同行业的公司，又比如教育经济学中在同一个班的同学。粗糙精确匹配可以轻松的推广到多变量匹配的情形，如同行业同年度的公司，同班同性别的同学。</p>
<h3 id="k-近邻匹配-k-nearest-neighbor-match">k-近邻匹配 k-nearest neighbor match</h3>
<p>k-近邻匹配要求匹配变量是距离，它选取距离最近的 k 个观测值作为对照组。</p>
<h3 id="radius-caliper-match">radius (caliper) match</h3>
<p>半径 (卡尺) 匹配要求匹配变量也是距离，它事先设定半径 (上下半径可以不同)，找出设定范围内的全部观测值作为对照组。显然，随着半径的降低，匹配要求也更趋严格。</p>
<h2 id="多变量匹配-multi-variate-match">多变量匹配 multi-variate match</h2>
<p>多变量匹配的核心思路是降维 (dimension reduction)，将多变量降维为距离或得分，然后再运用单变量匹配的方法。多变量匹配的方法有欧氏距离、百分等级、马氏距离和倾向得分匹配等。</p>
<p>为能直观的图示，下文全部示例仅考虑双变量 (平面) 的情形。</p>
<h3 id="欧氏距离匹配-euclidean-distance-match">欧氏距离匹配 euclidean distance match</h3>
<p>最简单的测度空间就是欧氏距离空间。你可以轻松的用尺子直接量出点到原点、或任意两点之间的距离。</p>
<p>平面上任意点<span class="math inline">\(X=\left(X_{1}, X_{2}, \cdots, X_{n}\right)\)</span>到原点的距离公式为：</p>
<p><span class="math display">\[d_{e}(X)=\sqrt{X_{1}^{2}+X_{2}^{2}+\cdots+X_{n}^{2}}\]</span></p>
<p>平面上任意两点<span class="math inline">\(X=\left(X_{1}, X_{2}, \cdots, X_{n}\right)\)</span>和<span class="math inline">\(Y=\left(Y_{1}, Y_{2}, \cdots, Y_{n}\right)\)</span>之间的距离公式为： <span class="math display">\[d_{e}(X, Y)=\sqrt{\left(X_{1}-Y_{1}\right)^{2}+\left(X_{2}-Y_{2}\right)^{2}+\cdots+\left(X_{n}-Y_{n}\right)^{2}}\]</span> 在欧式距离空间中，坐标轴之间是相互垂直的，也就意味着随机变量之间的相关系数为零。这是一个非常强的假设，而实际研究中该假设往往不能成立。比如研究一个人的健康时，作为影响因素的身高和体重之间往往是正相关的。</p>
<p><font color="red"> 在欧式距离空间中，坐标轴上的量纲也是默认相同的，也就意味着随机变量必须有相同的量纲。这同样是一个过于严苛的假设。同样是研究一个人的健康，身高的单位是厘米，体重的单位是公斤，无论如何长度单位和重量单位是不可比的。</font></p>
<h3 id="马氏距离匹配-mahalanobis-distance-match">马氏距离匹配 mahalanobis distance match</h3>
<p>为了克服匹配时欧氏距离空间的上述两个缺陷，印度数学家 Mahalanobis 提出了著名的马氏距离空间。马氏距离对多匹配变量的联合分布的位置、形状做了标准化调整，也对多匹配变量之间的相关性做了正交化调整，从而将多匹配变量的联合分布转变为可以用欧氏距离计算的情形。</p>
<p>马氏距离实现上述功能的关键在于用协方差矩阵的逆矩阵做了调整。我们将在第三部分用 Stata 代码逐步展示它。任意点<span class="math inline">\(\vec{x}\)</span>到质心 (centroid) 的距离公式如下：</p>
<p><span class="math display">\[d_{m}(\vec{x})=\sqrt{(\vec{x}-\vec{c})^{\prime} \operatorname{Cov}^{-1}(\vec{x}-\vec{c})}\]</span></p>
<p>任意两点<span class="math inline">\(\vec{x_{1}}\)</span>和<span class="math inline">\(\vec{x_{2}}\)</span>之间的距离公式如下：</p>
<p><span class="math display">\[d_{m}\left(\vec{x}_{1}, \vec{x}_{2}\right)=\sqrt{\left(\vec{x}_{1}-\vec{x}_{2}\right)^{\prime} \operatorname{Cov}^{-1}\left(\vec{x}_{1}-\vec{x}_{2}\right)}\]</span></p>
<p>其中<span class="math inline">\(\operatorname{Cov}\)</span>为多维随机变量的样本协方差矩阵，<span class="math inline">\(c\)</span>是质心或样本均值。若样本协方差矩阵是单位矩阵 (各维度之间独立同部分)，马氏距离退化为欧氏距离。</p>
<p>马氏距离测量相对于质心的距离，质心是一个基准点或中心点，可以认为是多元数据的总体平均值。质心是多元空间中所有变量的均值相交的点。马氏距离越大，数据点离质心越远。</p>
<h3 id="百分等级匹配-percentile-rank-match">百分等级匹配 percentile rank match</h3>
<p>在多随机变量的联合分布中，距离近的点在概率分布函数 (PDF) 上往往不一定靠近。我们以如下标准正态分布 (钟形曲线) 为例,说明距离相近并不必然等于概率分布上的靠近。</p>
<p>不妨设样本容量为10000。处理组观测值点 A 位于距离原点<span class="math inline">\(2\sigma\)</span>处。则<span class="math inline">\(- \sigma\)</span>的点B和<span class="math inline">\(-3 \sigma\)</span>处的点C与点A的距离相等，都等于 。但是点A与点B之间有1359(13.59%) 个观测值，而点A与点C之间仅有214(2.14 )个观测值。显然，尽管点A到点B和点C的距离是相等的，但从概率分布的角度来看在点A前后抽样更容易抽到点C。</p>
<figure>
<img src="https://gitee.com/shao818/Figure/raw/master/null/image-20201206103307494.png" alt=""><figcaption>钟形曲线</figcaption>
</figure>
<p>百分等级是一个相对位置量数。它是指将距离按照从小到大的顺序排列，小于某观测值距离的观测值个数与样本数的百分比，即为该观测值的百分等级。</p>
<p>不同于百分数 (percentile)，有相同距离的观测值总是有相同的百分等级 (percentile rank)，以消除指定百分等级时的武断性 (arbitrariness)。因此，百分等级的公式如下：</p>
<p><span class="math display">\[P R=\frac{L+0.5 E}{N}\]</span></p>
<p>其中，<span class="math inline">\(PR\)</span>是百分等级，<span class="math inline">\(L\)</span>是距离小于该观测值距离的观测值数,<span class="math inline">\(E\)</span>是距离等于该观测值距离的观测值数，<span class="math inline">\(N\)</span>是样本数。例如，样本有100个同学参加考试，你的物理得分是85分，其中有60个人分数低于你，5个人的分数和你相同，则你的百分等级数就等于：</p>
<p><span class="math display">\[\frac{60+0.5 \times 5}{100}=62.5 \%\]</span></p>
<p>百分等级匹配就是选择百分等级最接近的观测值作为反事实观测值，显然它是一种非参数方法。基于距离的百分等级不仅克服了距离不能体现随机变量分布函数的特点 (比如距离很远的点也可能有相似的百分等级)，而且将匹配变量之间的差异限制在<span class="math inline">\([0,1]\)</span>区间。然而它仍有自己的局限，就是无法体现个体进入处理组的<strong>选择过程</strong>，或者说并没有利用到底哪些个体进入了处理组这个关键信息。</p>
<h3 id="倾向得分匹配-propensity-score-match">倾向得分匹配 propensity score match</h3>
<p><font color="red"> 倾向得分匹配不是基于距离而是基于得分。</font>倾向得分 (propensity score) 是指个体 <span class="math inline">\(i\)</span> 在给定可观测变量<span class="math inline">\(x_{i}\)</span>的情况下进入处理组的条件概率。即<span class="math inline">\(p(x_{i})=Pr(D_{i}=1\mid x=x_{i})\)</span>，或简记为<span class="math inline">\(p_{x}\)</span>。</p>
<p>对倾向得分的估计可使用参数估计或非参数估计，最流行的方法是<span class="math inline">\(logit\)</span>。Rosenbaum and Rubin (1983) 证明，如果可忽略性假定成立，则在给定倾向得分的情况下，结果变量在事前和事后的取值独立于是否个体进入处理组。</p>
<p>使用倾向得分匹配需要满足两个假定：1.共同支撑假设；2.平衡性假定。</p>
<p>共同支撑集是指这样一个集合，不妨设备择组观测值的倾向得分的取值范围为 <span class="math inline">\([p_{min}^{\mu}, p_{max}^{\mu}]\)</span>设处理组观测值得倾向得分取值范围为<span class="math inline">\([p_{min}^{t}, p_{max}^{t}]\)</span>，则共同支撑集内的任意观测值的倾向得分必需大于备择组和处理组的最小倾向得分中较大的那个，也必需小于最大倾向得分中较小的那个。即进入共同支撑集的观测值必需位于如下区间内：</p>
<p><span class="math display">\[\left[\max \left(p_{\min }^{u}, p_{\min }^{t}\right), \min \left(p_{\max }^{u}, p_{\max }^{t}\right)\right]\]</span></p>
<p>其中<span class="math inline">\(p_{min}^{\mu}\)</span>是对照组倾向得分的最小值，<span class="math inline">\(p_{max}^{\mu}\)</span>是对照组倾向得分的最大值；<span class="math inline">\(p_{min}^{t}\)</span> 是处理组倾向得分的最小值，<span class="math inline">\(p_{min}^{t}\)</span>是处理组倾向得分的最大值。</p>
<p>在匹配时，为提供匹配质量，可仅保留倾向得分重叠部分的个体。共同支撑假设要求共同支撑集的取值范围不能太小，则匹配成功的样本可能不具有代表性。</p>
<p>再说平衡性假定，如果倾向得分估计是准确的，那么协变量 在匹配后的处理组与控制组之间分布较均匀。例如，匹配后处理组的均值 <span class="math inline">\(\bar{x}^{t}\)</span>与对照组的均值<span class="math inline">\(\bar{x}^{\mu}\)</span>应该较接近，也就是所谓的“数据平衡”。</p>
<p>多接近是接近？均值之间的差异与计量单位有关，你当然可以做组间均值差异或中位数差异检验，也可以使用标准化偏差 (standarized bias) 进行比较，公式如下：</p>
<p><span class="math display">\[\frac{\bar{x}^{t}-\bar{x}^{u}}{\sqrt{\left(s_{x}^{t}\right)^{2}+\left(s_{x}^{u}\right)^{2} / 2}}\]</span></p>
<p><font color="red"> 经验法则告诉我们，标准化差距不得超过 10%。如果超过，则应重新估计倾向得分，或改变具体的匹配方法。<font color="red"></font></font></p><font color="red"><font color="red">
<p>尽管倾向得分匹配体现了选择过程，但它仍有一些缺陷，比如它只能依可测变量选择，对共同支撑集有要求等。</p>
<h2 id="代码展示">代码展示</h2>
<p>我们用简单的二维模拟数据来展示不同多变量匹配方法之间的差异。</p>
<h3 id="数据生成过程">数据生成过程</h3>
<pre class="line-numbers language-stata" data-language="stata"><code class="language-stata">clear
qui  set obs 200
qui gen id = _n
qui set seed 10000
qui gen r0 = rnormal()
qui set seed 12345
gen r1 = rnormal()
qui set seed 65432
qui gen r2 = rnormal()
qui set seed 10101
qui gen re = rnormal()
*-选择变量
gen x1 = 2 * (r0 + r1)
gen x2 = 3 + (r0 + r2)
*-选择机制
qui gen group = 2 * x1 - 3 * x2 + 10 * re &gt; 0		
qui label def group 0 "非对照组" 1 "处理组"
qui label val group group<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-stata" data-language="stata"><code class="language-stata">*-数据分布
keep id x1 x2 group
tab group
correlate x1 x2
twoway (scatter x1 x2 if group == 0, mcolor(black))	///
	   (scatter x1 x2 if group == 1, mcolor(red)), 	///
	   title("数据分布") xlabel(-10(5)10) ///
       ylabel(-10(5)10, nogrid) ///
       aspect(1) legend(off)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>​<br>
​</p>
<pre><code>      group |      Freq.     Percent        Cum.
------------+-----------------------------------
   非对照组 |        157       78.50       78.50
     处理组 |         43       21.50      100.00
------------+-----------------------------------
      Total |        200      100.00

(obs=200)

             |       x1       x2
-------------+------------------
          x1 |   1.0000
          x2 |   0.5411   1.0000



![image-20201206162443676](https://gitee.com/shao818/Figure/raw/master/null/image-20201206162443676.png)</code></pre>
<div data-align="center">
上图中，红色的点为处理组观测值，黑色的点为对照组观测值
</div>
<h3 id="欧氏距离匹配的结果">3.2 欧氏距离匹配的结果</h3>
<p>变量 <em>ec</em> 记录欧氏距离匹配得到的匹配值</p>
<pre class="line-numbers language-stata" data-language="stata"><code class="language-stata">gen ec = .
gen ed = .
forvalues i = 1(1)200 {
  if group[`i'] == 1 {
    forvalues j = 1(1)200 {
      if group[`j'] == 0 {
        local d = sqrt((x1[`i'] - x1[`j'])^2 + (x2[`i'] - x2[`j'])^2)
        if `d' &lt; ed[`i'] {
          qui replace ec = `j' in `i'
          qui replace ed = `d' in `i'
        }
      }
    }
  }
}
tab group
misstable sum ec ed	<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre><code>(200 missing values generated)

(200 missing values generated)</code></pre>
<p>​<br>
​</p>
<pre><code>      group |      Freq.     Percent        Cum.
------------+-----------------------------------
   非对照组 |        157       78.50       78.50
     处理组 |         43       21.50      100.00
------------+-----------------------------------
      Total |        200      100.00

                                                               Obs&lt;.
                                                +------------------------------
               |                                | Unique
      Variable |     Obs=.     Obs&gt;.     Obs&lt;.  | values        Min         Max
  -------------+--------------------------------+------------------------------
            ec |       157                  43  |     32          3         182
            ed |       157                  43  |     43   .0474581     2.99655
  -----------------------------------------------------------------------------</code></pre>
<figure>
<img src="https://gitee.com/shao818/Figure/raw/master/null/image-20201206110317875.png" alt=""><figcaption>欧氏距离匹配的结果</figcaption>
</figure>
<h3 id="马氏距离匹配的结果">3.3 马氏距离匹配的结果</h3>
<p>变量 <em>mc</em> 记录马氏距离匹配得到的匹配值</p>
<pre class="line-numbers language-stata" data-language="stata"><code class="language-stata">corr x1 x2, cov
mat cov = r(C)
mat cov = inv(cov)
mat list cov
scalar a_11 = cov[1, 1]
scalar a_22 = cov[2, 2]
scalar a_21 = cov[2, 1]
gen mc = .
gen md = .
forvalues i = 1(1)200 {
  if group[`i'] == 1 {
    forvalues j = 1(1)200 {
      if group[`j'] == 0 {
        local d = sqrt(a_11*(x1[`i'] - x1[`j'])^2 + a_22*(x2[`i'] - x2[`j'])^2 + 2 * a_21 * (x1[`i'] - x1[`j']))
        if `d' &lt; md[`i'] {
          qui replace mc = `j' in `i'
          qui replace md = `d' in `i'
        }
      }
    }
  }
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre><code>(obs=200)

             |       x1       x2
-------------+------------------
          x1 |  9.13632
          x2 |  2.21438  1.83322</code></pre>
<p>​<br>
​<br>
​<br>
​</p>
<pre><code>symmetric cov[2,2]
            x1          x2
x1   .15476227
x2  -.18694053   .77129752</code></pre>
<p>​<br>
​<br>
​</p>
<pre><code>(200 missing values generated)

(200 missing values generated)</code></pre>
<p>​</p>
<figure>
<img src="https://gitee.com/shao818/Figure/raw/master/null/image-20201206110442743.png" alt=""><figcaption>马氏距离匹配的结果</figcaption>
</figure>
<h3 id="倾向得分匹配的结果">3.4 倾向得分匹配的结果</h3>
<p>变量 <em>pc</em> 记录倾向得分匹配得到的匹配值</p>
<pre class="line-numbers language-stata" data-language="stata"><code class="language-stata">gen pc = .
gen pd = .	
probit group x1 x2
predict score, xb
replace score = normal(score)
forvalues i = 1(1)200 {
  if group[`i'] == 1 {
    forvalues j = 1(1)200 {
      if group[`j'] == 0 {
        local d = abs(score[`i'] - score[`j'])
        if `d' &lt; pd[`i'] {
          qui replace pc = `j' in `i'
          qui replace pd = `d' in `i'
        }
      }
    }
  }
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre><code>(200 missing values generated)

(200 missing values generated)</code></pre>
<p>​</p>
<pre><code>Iteration 0:   log likelihood = -104.10128  
Iteration 1:   log likelihood = -87.202389  
Iteration 2:   log likelihood =  -86.81419  
Iteration 3:   log likelihood = -86.812732  
Iteration 4:   log likelihood = -86.812732  

Probit regression                               Number of obs     =        200
                                                LR chi2(2)        =      34.58
                                                Prob &gt; chi2       =     0.0000
Log likelihood = -86.812732                     Pseudo R2         =     0.1661

------------------------------------------------------------------------------
       group |      Coef.   Std. Err.      z    P&gt;|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
          x1 |   .2616765   .0504464     5.19   0.000     .1628034    .3605496
          x2 |  -.4125467   .1041879    -3.96   0.000    -.6167512   -.2083422
       _cons |   .2191261   .2985862     0.73   0.463    -.3660921    .8043443
------------------------------------------------------------------------------</code></pre>
<p>​</p>
<pre><code>(200 real changes made)</code></pre>
<p>​</p>
<figure>
<img src="https://gitee.com/shao818/Figure/raw/master/null/image-20201206110656185.png" alt=""><figcaption>倾向得分匹配的结果</figcaption>
</figure>
<h2 id="参考文献和资料">参考文献和资料</h2>
<ul>
<li>Mahalanobis Distance: Simple Definition, Examples link</li>
<li>Mahalanobis, P. C. (1936). On the generalized distance in statistics. National Institute of Science of India. pdf</li>
<li>Percentiles, Percentile Rank &amp; Percentile Range: Definition &amp; Examples link</li>
<li>Rosenbaum, P. R., &amp; Rubin, D. B. (1983). The central role of the propensity score in observational studies for causal effects. <em>Biometrika</em>, <em>70</em>(1), 41-55. pdf</li>
</ul>
<h1 id="倾向得分匹配法的实现pscore">倾向得分匹配法的实现：<code>pscore</code></h1>
<pre class="line-numbers language-stata" data-language="stata"><code class="language-stata">cd C:\Mirror\StataLearn\StataData
use nswpsid.dta,clear
*browse<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<pre><code>C:\Mirror\StataLearn\StataData</code></pre>
<p>​</p>
<pre class="line-numbers language-stata" data-language="stata"><code class="language-stata">*我手头的数据变量名全部为大写，便于观察，我统一修改为小写
rename _all,lower<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<pre class="line-numbers language-stata" data-language="stata"><code class="language-stata">reg re78 treat<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<pre><code>      Source |       SS           df       MS      Number of obs   =     2,675
-------------+----------------------------------   F(1, 2673)      =    173.41
       Model |  3.9811e+10         1  3.9811e+10   Prob &gt; F        =    0.0000
    Residual |  6.1365e+11     2,673   229573201   R-squared       =    0.0609
-------------+----------------------------------   Adj R-squared   =    0.0606
       Total |  6.5346e+11     2,674   244375675   Root MSE        =     15152

------------------------------------------------------------------------------
        re78 |      Coef.   Std. Err.      t    P&gt;|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
       treat |  -15204.78   1154.614   -13.17   0.000     -17468.8   -12940.75
       _cons |   21553.92   303.6414    70.98   0.000     20958.53    22149.32
------------------------------------------------------------------------------</code></pre>
<pre class="line-numbers language-stata" data-language="stata"><code class="language-stata">reg re78 treat age educ black hisp marr re74 re75 agesq educsq nodegree re74sq re75sq u74black u74hisp<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<pre><code>      Source |       SS           df       MS      Number of obs   =     2,675
-------------+----------------------------------   F(15, 2659)     =    254.55
       Model |  3.8521e+11        15  2.5681e+10   Prob &gt; F        =    0.0000
    Residual |  2.6825e+11     2,659   100884505   R-squared       =    0.5895
-------------+----------------------------------   Adj R-squared   =    0.5872
       Total |  6.5346e+11     2,674   244375675   Root MSE        =     10044

------------------------------------------------------------------------------
        re78 |      Coef.   Std. Err.      t    P&gt;|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
       treat |   275.1949   1110.779     0.25   0.804    -1902.882    2453.272
         age |   75.09001   157.2443     0.48   0.633    -233.2436    383.4236
        educ |  -315.5722   364.6524    -0.87   0.387    -1030.603    399.4589
       black |  -786.4703   503.0553    -1.56   0.118     -1772.89    199.9489
        hisp |   2508.966   1188.907     2.11   0.035     177.6904    4840.241
        marr |   1140.549   591.6965     1.93   0.054    -19.68268    2300.781
        re74 |   .2943587   .0533481     5.52   0.000     .1897508    .3989666
        re75 |   .6239079   .0487918    12.79   0.000     .5282341    .7195816
       agesq |  -2.329855   2.135465    -1.09   0.275    -6.517196    1.857485
      educsq |   38.24418   14.92522     2.56   0.010      8.97797    67.51039
    nodegree |   401.6618   652.1677     0.62   0.538    -877.1456    1680.469
      re74sq |  -2.05e-07   8.88e-07    -0.23   0.818    -1.95e-06    1.54e-06
      re75sq |  -1.07e-06   7.79e-07    -1.37   0.171    -2.59e-06    4.61e-07
    u74black |   2348.742   1191.527     1.97   0.049     12.32794    4685.157
     u74hisp |  -1640.353   2891.265    -0.57   0.571     -7309.71    4029.004
       _cons |   1928.646   3582.802     0.54   0.590    -5096.715    8954.008
------------------------------------------------------------------------------</code></pre>
<pre class="line-numbers language-stata" data-language="stata"><code class="language-stata">**--基本命令--**

global breps 1000
*设定重复抽样全局宏1000次

global vars age agesq educ educsq black hisp marr re74 re75 re74sq u74 u75 u74hisp nodegree  
*设定一个全局宏vars，代表后面的变量<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-stata" data-language="stata"><code class="language-stata">pscore treat $vars, pscore(myscore) comsup blockid(myblock) numblo(10) level(0.005) logit

*设置block，设置显著性水平0.005，采用logit估计。一般而言，logit和probit都是比较常用的估计方法。
*这个模型也叫作选择模型。
*我们应该先检验打分的平衡性。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>​<br>
​</p>
<pre><code>**************************************************** 
Algorithm to estimate the propensity score 
**************************************************** </code></pre>
<p>​</p>
<pre><code>The treatment is treat

      treat |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |      2,490       93.08       93.08
          1 |        185        6.92      100.00
------------+-----------------------------------
      Total |      2,675      100.00</code></pre>
<p>​<br>
​</p>
<pre><code>Estimation of the propensity score 

Iteration 0:   log likelihood = -672.64954
Iteration 1:   log likelihood = -551.87026
Iteration 2:   log likelihood = -355.56578
Iteration 3:   log likelihood = -234.78051
Iteration 4:   log likelihood =  -208.2965
Iteration 5:   log likelihood = -199.26423
Iteration 6:   log likelihood = -197.26114
Iteration 7:   log likelihood =  -197.1054
Iteration 8:   log likelihood = -197.10179
Iteration 9:   log likelihood = -197.10175

Logistic regression                               Number of obs   =       2675
                                                  LR chi2(14)     =     951.10
                                                  Prob &gt; chi2     =     0.0000
Log likelihood = -197.10175                       Pseudo R2       =     0.7070

------------------------------------------------------------------------------
       treat |      Coef.   Std. Err.      z    P&gt;|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
         age |   .2628422    .120206     2.19   0.029     .0272428    .4984416
       agesq |  -.0053794   .0018341    -2.93   0.003    -.0089742   -.0017846
        educ |   .7149774   .3418173     2.09   0.036     .0450278    1.384927
      educsq |  -.0426178   .0179039    -2.38   0.017    -.0777088   -.0075269
       black |   2.519383    .370358     6.80   0.000     1.793495    3.245272
        hisp |   3.087327   .7340486     4.21   0.000     1.648618    4.526036
        marr |  -1.780857    .301802    -5.90   0.000    -2.372378   -1.189336
        re74 |  -.0000448   .0000425    -1.05   0.292     -.000128    .0000385
        re75 |  -.0002678   .0000485    -5.52   0.000    -.0003628   -.0001727
      re74sq |   1.99e-09   7.75e-10     2.57   0.010     4.72e-10    3.51e-09
         u74 |   3.100056   .5187391     5.98   0.000     2.083346    4.116766
         u75 |  -1.273525   .4644557    -2.74   0.006    -2.183842   -.3632088
     u74hisp |  -1.925803    1.07186    -1.80   0.072     -4.02661    .1750032
    nodegree |   .1891046   .4257533     0.44   0.657    -.6453564    1.023566
       _cons |  -7.407524   2.445692    -3.03   0.002    -12.20099   -2.614056
------------------------------------------------------------------------------
Note: 65 failures and 0 successes completely determined.</code></pre>
<p>​<br>
​</p>
<pre><code>Note: the common support option has been selected
The region of common support is [.00036433, .98576756]</code></pre>
<p>​<br>
​</p>
<pre><code>Description of the estimated propensity score 
in region of common support 

                 Estimated propensity score
-------------------------------------------------------------
      Percentiles      Smallest
 1%     .0003871       .0003643
 5%     .0004805       .0003669
10%     .0006343       .0003702       Obs               1,271
25%     .0016393       .0003714       Sum of Wgt.       1,271

50%     .0090427                      Mean           .1447205
                        Largest       Std. Dev.      .2809511
75%     .0897599       .9803043
90%      .656286       .9830988       Variance       .0789335
95%     .9392306       .9855413       Skewness       2.049999
99%     .9640553       .9857676       Kurtosis       5.748631</code></pre>
<p>​<br>
​</p>
<pre><code>****************************************************** 
Step 1: Identification of the optimal number of blocks 
Use option detail if you want more detailed output 
****************************************************** </code></pre>
<p>​</p>
<pre><code>The final number of blocks is 10

This number of blocks ensures that the mean propensity score
is not different for treated and controls in each blocks</code></pre>
<p>​<br>
​</p>
<pre><code>********************************************************** 
Step 2: Test of balancing property of the propensity score 
Use option detail if you want more detailed output 
********************************************************** 

Variable re74 is not balanced in block 8

Variable re74sq is not balanced in block 8

Variable u74 is not balanced in block 8

The balancing property is not satisfied 

Try a different specification of the propensity score 

  Inferior |
  of block |         treat
of pscore  |         0          1 |     Total
-----------+----------------------+----------
         0 |       960          9 |       969 
        .1 |        56         10 |        66 
        .2 |        15          7 |        22 
        .3 |        18          7 |        25 
        .4 |        15         12 |        27 
        .5 |         7         12 |        19 
        .6 |         5         21 |        26 
        .7 |         2         12 |        14 
        .8 |         2         14 |        16 
        .9 |         6         81 |        87 
-----------+----------------------+----------
     Total |     1,086        185 |     1,271 
Note: the common support option has been selected</code></pre>
<p>​</p>
<pre><code>******************************************* 
End of the algorithm to estimate the pscore 
******************************************* </code></pre>
<h2 id="方法一近邻匹配nearest-neighbor-matching">方法一：近邻匹配（nearest neighbor matching）</h2>
<ul>
<li>含义：最邻近匹配法是最常用的一种匹配方法，它把控制组中找到的与处理组个体倾向得分差异最小的个体，作为自己的比较对象 。</li>
<li>优点：按处理个体找控制个体，所有处理个体都会配对成功，处理组的信息得以充分使用。</li>
<li>缺点：由于不舍弃任何一个处理组，很可能有些配对组的倾向得分差距很大，也将其配对，导致配对质量不高，而处理效应ATT的结果中也会包含这一差距，使得ATT精确度下降。</li>
</ul>
<pre class="line-numbers language-stata" data-language="stata"><code class="language-stata">**--基本命令--**
set seed 12345
*（产生随机数种子）
attnd re78 treat $vars,comsup boot reps($breps) dots logit<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>​<br>
​<br>
​</p>
<pre><code> The program is searching the nearest neighbor of each treated unit. 
 This operation may take a while.</code></pre>
<p>​<br>
​</p>
<pre><code>ATT estimation with Nearest Neighbor Matching method 
(random draw version)
Analytical standard errors

---------------------------------------------------------
n. treat.   n. contr.         ATT    Std. Err.          t
---------------------------------------------------------

      185          60    1285.782     3895.044      0.330

---------------------------------------------------------
Note: the numbers of treated and controls refer to actual
nearest neighbour matches</code></pre>
<p>​<br>
​<br>
​<br>
​</p>
<pre><code>Bootstrapping of standard errors 

command:      attnd re78 treat age agesq educ educsq black hisp marr re74 re75 r
&gt; e74sq u74 u75 u74hisp nodegree , pscore() logit comsup
statistic:    attnd      = r(attnd)
................................................................................
&gt; ..............................................................................
&gt; ..............................................................................
&gt; ..............................................................................
&gt; ..............................................................................
&gt; ..............................................................................
&gt; ..............................................................................
&gt; ..............................................................................
&gt; ..............................................................................
&gt; ..............................................................................
&gt; ..............................................................................
&gt; ..............................................................................
&gt; ..............................................................

note: label truncated to 80 characters

Bootstrap statistics                              Number of obs    =      2675
                                                  Replications     =      1000

------------------------------------------------------------------------------
Variable     |  Reps  Observed      Bias  Std. Err. [95% Conf. Interval]
-------------+----------------------------------------------------------------
       attnd |  1000  1285.782  301.0502  1268.737  -1203.913   3775.477   (N)
             |                                      -1013.798   3885.525   (P)
             |                                      -2072.365   3301.271  (BC)
------------------------------------------------------------------------------
Note:  N   = normal
       P   = percentile
       BC  = bias-corrected</code></pre>
<p>​<br>
​</p>
<pre><code>ATT estimation with Nearest Neighbor Matching method
(random draw version)
Bootstrapped standard errors

---------------------------------------------------------
n. treat.   n. contr.         ATT   Std. Err.           t
---------------------------------------------------------

      185          60    1285.782    1268.737       1.013

---------------------------------------------------------
Note: the numbers of treated and controls refer to actual
nearest neighbour matches</code></pre>
<h2 id="方法二半径匹配radius-matching">方法二：半径匹配（radius matching）</h2>
<pre class="line-numbers language-stata" data-language="stata"><code class="language-stata">*半径匹配法是事先设定半径，找到所有设定半径范围内的单位圆中的控制样本，半径取值为正。随着半径的降低，匹配的要求越来越严。
set seed 12345
attr re78 treat $vars, comsup boot reps($breps) dots logit radius(0.001)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>​<br>
​<br>
​</p>
<pre><code> The program is searching for matches of treated units within radius. 
 This operation may take a while.</code></pre>
<p>​<br>
​</p>
<pre><code>ATT estimation with the Radius Matching method
Analytical standard errors

---------------------------------------------------------
n. treat.   n. contr.         ATT   Std. Err.           t
---------------------------------------------------------

       51         541   -7808.241    1146.418      -6.811

---------------------------------------------------------
Note: the numbers of treated and controls refer to actual
matches within radius</code></pre>
<p>​<br>
​<br>
​<br>
​</p>
<pre><code>Bootstrapping of standard errors 

command:      attr re78 treat age agesq educ educsq black hisp marr re74 re75 re
&gt; 74sq u74 u75 u74hisp nodegree , pscore() logit comsup radius(.001)
statistic:    attr       = r(attr)
................................................................................
&gt; ..............................................................................
&gt; ..............................................................................
&gt; ..............................................................................
&gt; ..............................................................................
&gt; ..............................................................................
&gt; ..............................................................................
&gt; ..............................................................................
&gt; ..............................................................................
&gt; ..............................................................................
&gt; ..............................................................................
&gt; ..............................................................................
&gt; ..............................................................

note: label truncated to 80 characters

Bootstrap statistics                              Number of obs    =      2675
                                                  Replications     =      1000

------------------------------------------------------------------------------
Variable     |  Reps  Observed      Bias  Std. Err. [95% Conf. Interval]
-------------+----------------------------------------------------------------
        attr |  1000 -7808.242  1681.651  3063.974   -13820.8  -1795.679   (N)
             |                                       -11035.8   509.8419   (P)
             |                                      -12358.52   -2307.59  (BC)
------------------------------------------------------------------------------
Note:  N   = normal
       P   = percentile
       BC  = bias-corrected</code></pre>
<p>​<br>
​</p>
<pre><code>ATT estimation with the Radius Matching method
Bootstrapped standard errors

---------------------------------------------------------
n. treat.   n. contr.         ATT   Std. Err.           t
---------------------------------------------------------

       51         541   -7808.242    3063.974      -2.548

---------------------------------------------------------
Note: the numbers of treated and controls refer to actual
matches within radius</code></pre>
<h2 id="方法三分层匹配stratification-matching">方法三：分层匹配（stratification matching）</h2>
<ul>
<li>分层匹配法是根据估计的倾向得分将全部样本分块，使得每块的平均倾向得分在处理组和控制组中相等。</li>
<li>优点：Cochrane,Chambers（1965）指出五个区就可以消除95%的与协变量相关的偏差。这个方法考虑到了样本的分层问题或聚类问题。 就是假定：每一层内的个体样本具有相关性，而各层之间的样本不具有相关性。</li>
<li>缺点：如果在每个区内找不到对照个体，那么这类个体的信息，会丢弃不用。总体配对的数量减少。</li>
</ul>
<pre class="line-numbers language-stata" data-language="stata"><code class="language-stata">**--基本命令--**
set seed 12345
atts re78 treat $vars, pscore(myscore) blockid(myblock) comsup boot reps($breps) dots<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>​<br>
​<br>
​<br>
​</p>
<pre><code>ATT estimation with the Stratification method
Analytical standard errors

---------------------------------------------------------
n. treat.   n. contr.         ATT   Std. Err.           t
---------------------------------------------------------

      185        1086    1436.141     878.679       1.634

---------------------------------------------------------</code></pre>
<p>​<br>
​<br>
​<br>
​</p>
<pre><code>Bootstrapping of standard errors 

command:      atts re78 treat age agesq educ educsq black hisp marr re74 re75 re
&gt; 74sq u74 u75 u74hisp nodegree , pscore(myscore) blockid(myblock) comsup
statistic:    atts       = r(atts)
................................................................................
&gt; ..............................................................................
&gt; ..............................................................................
&gt; ..............................................................................
&gt; ..............................................................................
&gt; ..............................................................................
&gt; ..............................................................................
&gt; ..............................................................................
&gt; ..............................................................................
&gt; ..............................................................................
&gt; ..............................................................................
&gt; ..............................................................................
&gt; ..............................................................

note: label truncated to 80 characters

Bootstrap statistics                              Number of obs    =      2675
                                                  Replications     =      1000

------------------------------------------------------------------------------
Variable     |  Reps  Observed      Bias  Std. Err. [95% Conf. Interval]
-------------+----------------------------------------------------------------
        atts |  1000  1436.141  14.08074  988.5672  -503.7653   3376.048   (N)
             |                                      -443.7835   3479.466   (P)
             |                                       -436.341   3513.302  (BC)
------------------------------------------------------------------------------
Note:  N   = normal
       P   = percentile
       BC  = bias-corrected</code></pre>
<p>​<br>
​</p>
<pre><code>ATT estimation with the Stratification method
Bootstrapped standard errors

---------------------------------------------------------
n. treat.   n. contr.         ATT   Std. Err.           t
---------------------------------------------------------

      185        1086    1436.141     988.567       1.453

---------------------------------------------------------</code></pre>
<h2 id="方法四核匹配法kernel-matching">方法四：核匹配法（kernel matching）</h2>
<p>核匹配是一种非参数方法，通过构造一个虚拟对象来匹配处理组，构造的原则是对现有的控制变量做权重平均，权重的取值与处理组、控制组PS值差距呈反向相关关系。</p>
<pre class="line-numbers language-stata" data-language="stata"><code class="language-stata">**--基本命令--**

set seed 12345
attk  re78 treat $vars,comsup boot reps($breps) dots logit<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>​<br>
​<br>
​</p>
<pre><code> The program is searching for matches of each treated unit. 
 This operation may take a while.</code></pre>
<p>​<br>
​</p>
<pre><code>ATT estimation with the Kernel Matching method 

---------------------------------------------------------
n. treat.   n. contr.         ATT   Std. Err.           t
---------------------------------------------------------

      185        1086    1342.016           .           .

---------------------------------------------------------
Note: Analytical standard errors cannot be computed. Use
the bootstrap option to get bootstrapped standard errors.</code></pre>
<p>​<br>
​<br>
​<br>
​</p>
<pre><code>Bootstrapping of standard errors 

command:      attk re78 treat age agesq educ educsq black hisp marr re74 re75 re
&gt; 74sq u74 u75 u74hisp nodegree , pscore() logit comsup bwidth(.06)
statistic:    attk       = r(attk)
................................................................................
&gt; ..............................................................................
&gt; ..............................................................................
&gt; ..............................................................................
&gt; ..............................................................................
&gt; ..............................................................................
&gt; ..............................................................................
&gt; ..............................................................................
&gt; ..............................................................................
&gt; ..............................................................................
&gt; ..............................................................................
&gt; ..............................................................................
&gt; ..............................................................

note: label truncated to 80 characters

Bootstrap statistics                              Number of obs    =      2675
                                                  Replications     =      1000

------------------------------------------------------------------------------
Variable     |  Reps  Observed      Bias  Std. Err. [95% Conf. Interval]
-------------+----------------------------------------------------------------
        attk |  1000  1342.016  19.94675  1023.717  -666.8665   3350.899   (N)
             |                                      -550.7159    3380.17   (P)
             |                                      -543.5536   3382.363  (BC)
------------------------------------------------------------------------------
Note:  N   = normal
       P   = percentile
       BC  = bias-corrected</code></pre>
<p>​<br>
​</p>
<pre><code>ATT estimation with the Kernel Matching method
Bootstrapped standard errors

---------------------------------------------------------
n. treat.   n. contr.         ATT   Std. Err.           t
---------------------------------------------------------

      185        1086    1342.016    1023.717       1.311

---------------------------------------------------------</code></pre>
<h2 id="方法五马氏距离">方法五：马氏距离</h2>
<p>由于在倾向得分匹配第一阶段估计倾向得分时存在不确定性，Abadie and Imbens的相关研究又重新回到更简单的马氏距离，进行有放回且允许并列的k近邻匹配，针对非精确匹配一般存在偏差，提出了偏差校正的方法，通过回归的方法估计偏差，然后得到偏差校正匹配估计量。</p>
<pre class="line-numbers language-stata" data-language="stata"><code class="language-stata">**--基本命令--**
nnmatch re78 treat $vars, m(4) tc(att) population  bias(bias) robust(4)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<pre><code>Matching estimator: Population Average Treatment Effect for the Treated

Weighting matrix: inverse variance          Number of obs          =      2675
                                            Number of matches  (m) =         4
                                            Number of matches, 
                                              robust std. err. (h) =         4

------------------------------------------------------------------------------
        re78 |      Coef.   Std. Err.      z    P&gt;|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
        PATT |   2324.278   831.4603     2.80   0.005     694.6459     3953.91
------------------------------------------------------------------------------
Matching variables:  age agesq educ educsq black hisp marr re74 re75 re74sq
        u74 u75 u74hisp nodegree
Bias-adj variables:  age agesq educ educsq black hisp marr re74 re75 re74sq
        u74 u75 u74hisp nodegree</code></pre>
<h1 id="倾向得分匹配法的实现psmatch2">倾向得分匹配法的实现：<code>psmatch2</code></h1>
<p>其实呢，psmatch2和pscore除了句法结构稍有不同之外，估计的结果等是完全相同的。</p>
<p>我大致列一下命令，感兴趣的朋友可以自行尝试。</p>
<h2 id="基本命令">基本命令</h2>
<p></p><pre class="line-numbers language-none"><code class="language-none">psmatch2 depvar [indepvars] [if exp] [in range] [, outcome(varlist) pscore(varname)
                     neighbor(integer) radius caliper(real) mahalanobis(varlist) ai(integer) population
                     altvariance kernel llr kerneltype(type) bwidth(real) spline nknots(integer) common
                     trim(real) noreplacement descending odds index logit ties quietly w(matrix) ate]
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p></p>
<ul>
<li><code>neighbor(integer)</code> number of neighbors used to calculate the matched outcome.Defaults to 1. Default matching method is single nearest-neighbour (without caliper).<br>
</li>
<li><code>noreplacement</code> perform 1-to-1 matching without replacement. Nearest neigbor propensity score matching only.<br>
</li>
<li><code>descending</code> perform 1-to-1 matching without replacement in descending order. Nearest neighbor propensity score matching only.<br>
</li>
<li><code>ties</code> not only match nearest neighbor but also other controls with identical (tied) pscores.<br>
</li>
<li><code>radius</code> perform radius matching within the specified radius given by caliper.<br>
</li>
<li><code>caliper(real)</code> value for maximum distance of controls. Use to perform nearest neighbor(s) within caliper, radius matching and Mahalanobis 1-to-1 matching.</li>
<li><code>kernel</code> perform kernel matching.</li>
<li>kerneltype(kernel_type) specifies the type of kernel:
<ul>
<li><code>normal</code> the gaussian kernel.</li>
<li><code>biweight</code> the biweight kernel.</li>
<li><code>epan</code> the epanechnikov kernel (Default).</li>
<li><code>uniform</code> the uniform kernel.<br>
</li>
</ul></li>
<li><code>llr</code> llr use local linear regression matching instead of kernel matching.</li>
<li><code>bwidth(real)</code> the bandwidth for kernel and local linear regression matching. Default bandwidth is 0.06, except when doing local linear regression with the Epanechnikov kernel when the default bandwidth is the rule-of-thumb bandwidth of lpoly.</li>
<li><code>mahalanobis(varlist)</code> perform Mahalanobis-metric matching on varlist.</li>
</ul>
<pre class="line-numbers language-stata" data-language="stata"><code class="language-stata">use nswpsid,clear

rename _all,lower

global breps 1000
global vars age agesq educ educsq black hisp marr re74 re75 re74sq u74 u75 u74hisp nodegree  

psmatch2  treat $vars ,out(re78)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>​<br>
​<br>
​<br>
​<br>
​</p>
<pre><code>Probit regression                               Number of obs     =      2,675
                                                LR chi2(13)       =     940.49
                                                Prob &gt; chi2       =     0.0000
Log likelihood = -202.40579                     Pseudo R2         =     0.6991

------------------------------------------------------------------------------
       treat |      Coef.   Std. Err.      z    P&gt;|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
         age |   .1543439   .0644103     2.40   0.017     .0281021    .2805857
       agesq |  -.0030911   .0009855    -3.14   0.002    -.0050227   -.0011595
        educ |   .3889617   .1795042     2.17   0.030     .0371398    .7407835
      educsq |  -.0226529   .0092936    -2.44   0.015    -.0408681   -.0044377
       black |   1.345799   .1882886     7.15   0.000     .9767603    1.714838
        hisp |   1.586357   .3700556     4.29   0.000     .8610618    2.311653
        marr |  -.9527278    .154817    -6.15   0.000    -1.256163   -.6492921
        re74 |  -.0000227   .0000212    -1.07   0.285    -.0000643    .0000189
        re75 |  -.0001119   .0000205    -5.47   0.000     -.000152   -.0000718
      re74sq |   9.77e-10   3.51e-10     2.78   0.005     2.89e-10    1.67e-09
         u74 |    1.64806   .2656635     6.20   0.000     1.127369    2.168751
         u75 |   -.542294   .2432332    -2.23   0.026    -1.019022   -.0655657
     u74hisp |  -.9231337   .5719261    -1.61   0.107    -2.044088    .1978208
    nodegree |   .1278371   .2203571     0.58   0.562    -.3040549     .559729
       _cons |  -4.431708   1.310215    -3.38   0.001    -6.999682   -1.863734
------------------------------------------------------------------------------
Note: 507 failures and 0 successes completely determined.
--------------------------------------------------------------------------------
&gt; --------
        Variable     Sample |    Treated     Controls   Difference         S.E. 
&gt;   T-stat
----------------------------+---------------------------------------------------
&gt; --------
            re78  Unmatched | 6349.14537   21553.9213  -15204.7759   1154.61435 
&gt;   -13.17
                        ATT | 6349.14537   4600.46309   1748.68228   1825.51521 
&gt;     0.96
----------------------------+---------------------------------------------------
&gt; --------
Note: S.E. does not take into account that the propensity score is estimated.

           | psmatch2:
 psmatch2: |   Common
 Treatment |  support
assignment | On suppor |     Total
-----------+-----------+----------
 Untreated |     2,490 |     2,490 
   Treated |       185 |       185 
-----------+-----------+----------
     Total |     2,675 |     2,675 </code></pre>
<h2 id="近邻匹配">近邻匹配</h2>
<pre class="line-numbers language-stata" data-language="stata"><code class="language-stata">psmatch2  treat $vars,out(re78) neighbor(2) ate<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<pre><code>Probit regression                               Number of obs     =      2,675
                                                LR chi2(13)       =     940.49
                                                Prob &gt; chi2       =     0.0000
Log likelihood = -202.40579                     Pseudo R2         =     0.6991

------------------------------------------------------------------------------
       treat |      Coef.   Std. Err.      z    P&gt;|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
         age |   .1543439   .0644103     2.40   0.017     .0281021    .2805857
       agesq |  -.0030911   .0009855    -3.14   0.002    -.0050227   -.0011595
        educ |   .3889617   .1795042     2.17   0.030     .0371398    .7407835
      educsq |  -.0226529   .0092936    -2.44   0.015    -.0408681   -.0044377
       black |   1.345799   .1882886     7.15   0.000     .9767603    1.714838
        hisp |   1.586357   .3700556     4.29   0.000     .8610618    2.311653
        marr |  -.9527278    .154817    -6.15   0.000    -1.256163   -.6492921
        re74 |  -.0000227   .0000212    -1.07   0.285    -.0000643    .0000189
        re75 |  -.0001119   .0000205    -5.47   0.000     -.000152   -.0000718
      re74sq |   9.77e-10   3.51e-10     2.78   0.005     2.89e-10    1.67e-09
         u74 |    1.64806   .2656635     6.20   0.000     1.127369    2.168751
         u75 |   -.542294   .2432332    -2.23   0.026    -1.019022   -.0655657
     u74hisp |  -.9231337   .5719261    -1.61   0.107    -2.044088    .1978208
    nodegree |   .1278371   .2203571     0.58   0.562    -.3040549     .559729
       _cons |  -4.431708   1.310215    -3.38   0.001    -6.999682   -1.863734
------------------------------------------------------------------------------
Note: 507 failures and 0 successes completely determined.
--------------------------------------------------------------------------------
&gt; --------
        Variable     Sample |    Treated     Controls   Difference         S.E. 
&gt;   T-stat
----------------------------+---------------------------------------------------
&gt; --------
            re78  Unmatched | 6349.14537   21553.9213  -15204.7759   1154.61435 
&gt;   -13.17
                        ATT | 6349.14537   4570.95733   1778.18805   1626.12983 
&gt;     1.09
                        ATU | 21553.9213   5483.05914  -16070.8622            . 
&gt;        .
                        ATE |                          -14836.4419            . 
&gt;        .
----------------------------+---------------------------------------------------
&gt; --------
Note: S.E. does not take into account that the propensity score is estimated.

           | psmatch2:
 psmatch2: |   Common
 Treatment |  support
assignment | On suppor |     Total
-----------+-----------+----------
 Untreated |     2,490 |     2,490 
   Treated |       185 |       185 
-----------+-----------+----------
     Total |     2,675 |     2,675 </code></pre>
<h2 id="半径匹配">半径匹配</h2>
<pre class="line-numbers language-stata" data-language="stata"><code class="language-stata">psmatch2  treat $vars,out(re78)  ate radius caliper(0.01)<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<pre><code>Probit regression                               Number of obs     =      2,675
                                                LR chi2(13)       =     940.49
                                                Prob &gt; chi2       =     0.0000
Log likelihood = -202.40579                     Pseudo R2         =     0.6991

------------------------------------------------------------------------------
       treat |      Coef.   Std. Err.      z    P&gt;|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
         age |   .1543439   .0644103     2.40   0.017     .0281021    .2805857
       agesq |  -.0030911   .0009855    -3.14   0.002    -.0050227   -.0011595
        educ |   .3889617   .1795042     2.17   0.030     .0371398    .7407835
      educsq |  -.0226529   .0092936    -2.44   0.015    -.0408681   -.0044377
       black |   1.345799   .1882886     7.15   0.000     .9767603    1.714838
        hisp |   1.586357   .3700556     4.29   0.000     .8610618    2.311653
        marr |  -.9527278    .154817    -6.15   0.000    -1.256163   -.6492921
        re74 |  -.0000227   .0000212    -1.07   0.285    -.0000643    .0000189
        re75 |  -.0001119   .0000205    -5.47   0.000     -.000152   -.0000718
      re74sq |   9.77e-10   3.51e-10     2.78   0.005     2.89e-10    1.67e-09
         u74 |    1.64806   .2656635     6.20   0.000     1.127369    2.168751
         u75 |   -.542294   .2432332    -2.23   0.026    -1.019022   -.0655657
     u74hisp |  -.9231337   .5719261    -1.61   0.107    -2.044088    .1978208
    nodegree |   .1278371   .2203571     0.58   0.562    -.3040549     .559729
       _cons |  -4.431708   1.310215    -3.38   0.001    -6.999682   -1.863734
------------------------------------------------------------------------------
Note: 507 failures and 0 successes completely determined.
--------------------------------------------------------------------------------
&gt; --------
        Variable     Sample |    Treated     Controls   Difference         S.E. 
&gt;   T-stat
----------------------------+---------------------------------------------------
&gt; --------
            re78  Unmatched | 6349.14537   21553.9213  -15204.7759   1154.61435 
&gt;   -13.17
                        ATT | 5797.07774   4992.15701   804.920727   2941.28189 
&gt;     0.27
                        ATU | 22014.9702    4457.3058  -17557.6644            . 
&gt;        .
                        ATE |                          -16580.5462            . 
&gt;        .
----------------------------+---------------------------------------------------
&gt; --------
Note: S.E. does not take into account that the propensity score is estimated.

 psmatch2: |   psmatch2: Common
 Treatment |        support
assignment | Off suppo  On suppor |     Total
-----------+----------------------+----------
 Untreated |        88      2,402 |     2,490 
   Treated |        50        135 |       185 
-----------+----------------------+----------
     Total |       138      2,537 |     2,675 </code></pre>
<h2 id="核匹配">核匹配</h2>
<pre class="line-numbers language-stata" data-language="stata"><code class="language-stata">psmatch2  treat $vars,out(re78)  ate kernel<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<pre><code>Probit regression                               Number of obs     =      2,675
                                                LR chi2(13)       =     940.49
                                                Prob &gt; chi2       =     0.0000
Log likelihood = -202.40579                     Pseudo R2         =     0.6991

------------------------------------------------------------------------------
       treat |      Coef.   Std. Err.      z    P&gt;|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
         age |   .1543439   .0644103     2.40   0.017     .0281021    .2805857
       agesq |  -.0030911   .0009855    -3.14   0.002    -.0050227   -.0011595
        educ |   .3889617   .1795042     2.17   0.030     .0371398    .7407835
      educsq |  -.0226529   .0092936    -2.44   0.015    -.0408681   -.0044377
       black |   1.345799   .1882886     7.15   0.000     .9767603    1.714838
        hisp |   1.586357   .3700556     4.29   0.000     .8610618    2.311653
        marr |  -.9527278    .154817    -6.15   0.000    -1.256163   -.6492921
        re74 |  -.0000227   .0000212    -1.07   0.285    -.0000643    .0000189
        re75 |  -.0001119   .0000205    -5.47   0.000     -.000152   -.0000718
      re74sq |   9.77e-10   3.51e-10     2.78   0.005     2.89e-10    1.67e-09
         u74 |    1.64806   .2656635     6.20   0.000     1.127369    2.168751
         u75 |   -.542294   .2432332    -2.23   0.026    -1.019022   -.0655657
     u74hisp |  -.9231337   .5719261    -1.61   0.107    -2.044088    .1978208
    nodegree |   .1278371   .2203571     0.58   0.562    -.3040549     .559729
       _cons |  -4.431708   1.310215    -3.38   0.001    -6.999682   -1.863734
------------------------------------------------------------------------------
Note: 507 failures and 0 successes completely determined.
--------------------------------------------------------------------------------
&gt; --------
        Variable     Sample |    Treated     Controls   Difference         S.E. 
&gt;   T-stat
----------------------------+---------------------------------------------------
&gt; --------
            re78  Unmatched | 6349.14537   21553.9213  -15204.7759   1154.61435 
&gt;   -13.17
                        ATT | 6349.14537   5437.46536   911.680015   3074.54428 
&gt;     0.30
                        ATU | 21553.9213   11330.8223   -10223.099            . 
&gt;        .
                        ATE |                          -9453.03015            . 
&gt;        .
----------------------------+---------------------------------------------------
&gt; --------
Note: S.E. does not take into account that the propensity score is estimated.

           | psmatch2:
 psmatch2: |   Common
 Treatment |  support
assignment | On suppor |     Total
-----------+-----------+----------
 Untreated |     2,490 |     2,490 
   Treated |       185 |       185 
-----------+-----------+----------
     Total |     2,675 |     2,675 </code></pre>
<h2 id="对自变量进行平衡性检验">对自变量进行平衡性检验</h2>
<pre class="line-numbers language-stata" data-language="stata"><code class="language-stata">pstest $vars, both graph<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<pre><code>--------------------------------------------------------------------------------
&gt; --------
                Unmatched |       Mean               %reduct |     t-test    |  
&gt; V(T)/
Variable          Matched | Treated Control    %bias  |bias| |    t    p&gt;|t| |  
&gt; V(C)
--------------------------+----------------------------------+---------------+--
&gt; --------
age                    U  | 25.816   34.851   -100.9         | -11.57  0.000 |  
&gt; 0.47*
                       M  | 25.816   25.114      7.8    92.2 |   1.04  0.297 |  
&gt; 1.58*
                          |                                  |               |
agesq                  U  | 717.39   1323.5    -97.1         | -10.59  0.000 |  
&gt; 0.31*
                       M  | 717.39   662.88      8.7    91.0 |   1.31  0.190 |  
&gt; 1.40*
                          |                                  |               |
educ                   U  | 10.346   12.117    -68.1         |  -7.69  0.000 |  
&gt; 0.43*
                       M  | 10.346   10.734    -14.9    78.1 |  -1.91  0.057 |  
&gt; 1.13
                          |                                  |               |
educsq                 U  | 111.06   156.32    -78.5         |  -8.52  0.000 |  
&gt; 0.30*
                       M  | 111.06   118.77    -13.4    83.0 |  -1.88  0.061 |  
&gt; 0.98
                          |                                  |               |
black                  U  | .84324    .2506    148.0         |  18.13  0.000 |  
&gt;    .
                       M  | .84324   .84831     -1.3    99.1 |  -0.13  0.893 |  
&gt;    .
                          |                                  |               |
hisp                   U  | .05946   .03253     12.9         |   1.94  0.053 |  
&gt;    .
                       M  | .05946   .06369     -2.0    84.3 |  -0.17  0.866 |  
&gt;    .
                          |                                  |               |
marr                   U  | .18919   .86627   -184.2         | -25.81  0.000 |  
&gt;    .
                       M  | .18919   .13374     15.1    91.8 |   1.45  0.148 |  
&gt;    .
                          |                                  |               |
re74                   U  | 2095.6    19429   -171.8         | -17.50  0.000 |  
&gt; 0.13*
                       M  | 2095.6   2569.4     -4.7    97.3 |  -0.83  0.407 |  
&gt; 0.65*
                          |                                  |               |
re75                   U  | 1532.1    19063   -177.4         | -17.50  0.000 |  
&gt; 0.06*
                       M  | 1532.1   2518.3    -10.0    94.4 |  -2.14  0.033 |  
&gt; 0.36*
                          |                                  |               |
re74sq                 U  | 2.8e+07   5.6e+08    -85.7         |  -8.30  0.000 |
&gt;   0.02*
                       M  | 2.8e+07   4.3e+07     -2.4    97.2 |  -0.78  0.437 |
&gt;   0.24*
                          |                                  |               |
u74                    U  | .70811   .08635    164.2         |  27.54  0.000 |  
&gt;    .
                       M  | .70811   .64162     17.6    89.3 |   1.36  0.173 |  
&gt;    .
                          |                                  |               |
u75                    U  |     .6       .1    122.8         |  20.70  0.000 |  
&gt;    .
                       M  |     .6   .50136     24.2    80.3 |   1.91  0.057 |  
&gt;    .
                          |                                  |               |
u74hisp                U  | .03243   .00361     21.7         |   5.09  0.000 |  
&gt;    .
                       M  | .03243   .04352     -8.4    61.5 |  -0.56  0.578 |  
&gt;    .
                          |                                  |               |
nodegree               U  | .70811   .30522     87.9         |  11.49  0.000 |  
&gt;    .
                       M  | .70811   .65062     12.5    85.7 |   1.18  0.237 |  
&gt;    .
                          |                                  |               |
--------------------------------------------------------------------------------
&gt; --------
* if variance ratio outside [0.75; 1.34] for U and [0.75; 1.34] for M

--------------------------------------------------------------------------------
&gt; ---
 Sample    | Ps R2   LR chi2   p&gt;chi2   MeanBias   MedBias      B      R     %Va
&gt; r
-----------+--------------------------------------------------------------------
&gt; ---
 Unmatched | 0.699    940.49    0.000    108.7      99.0     298.4*   0.27*   10
&gt; 0
 Matched   | 0.039     19.82    0.136     10.2       9.4      42.8*   0.52     7
&gt; 1
--------------------------------------------------------------------------------
&gt; ---
* if B&gt;25%, R outside [0.5; 2]</code></pre>
<h2 id="共同支持区间">共同支持区间</h2>
<pre class="line-numbers language-stata" data-language="stata"><code class="language-stata">psgraph<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h1 id="倾向得分匹配psm中协变量的筛选">倾向得分匹配(PSM)中协变量的筛选</h1>
<blockquote>
<p>倾向得分匹配分析 (PSM) 已经在诸多领域得到了应用。虽然 PSM 不能完全解决内生性问题，但却能在很大程度上缓解自我选择问题导致的偏差。在前期文献中，Becker &amp; Ichino (2002, Stata Journal, 2(4):358-377) 对 PSM 的分析过程进行了详细的介绍，Stata 中也有多个命令可以执行 PSM 分析，如 <code>pscore</code>, <code>psmatch2</code>, <code>treatrew</code>(Stata Journal, 14(3): 541-561), <code>gpscore</code> (SJ 8(3):354--373), <code>kmatch</code></p>
</blockquote>
<pre class="line-numbers language-stata" data-language="stata"><code class="language-stata">net describe st0328,from(http://www.stata-journal.com/software/sj14-1)<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<pre><code>--------------------------------------------------------------------------------
package st0328 from http://www.stata-journal.com/software/sj14-1
--------------------------------------------------------------------------------

TITLE
      SJ14-1 st0328. Estimation of the generalized...

DESCRIPTION/AUTHOR(S)
      Estimation of the generalized propensity score
        through generalized linear models
      by Barbara Guardabascio, Istat, Italian National
           Institute of Statistics, Rome, Italy
         Marco Ventura, Istat, Italian National
           Institute of Statistics, Rome, Italy
      Support:  guardabascio@istat.it
      After installation, type help glmgpscore and
        glmdose
      This also requires doseresponse_model.ado; type
        {cmd:search doseresponse_model} and follow the links
        to install the latest package.

INSTALLATION FILES                               (type net install st0328)
      st0328/glmdose.ado
      st0328/glmgpscore.ado
      st0328/glmdose.sthlp
      st0328/glmgpscore.sthlp

ANCILLARY FILES                                  (type net get st0328)
      st0328/lotterydataset.dta
      st0328/output_flog.dta
      st0328/output_proof.dta
      st0328/examples.do
--------------------------------------------------------------------------------</code></pre>
<h2 id="平衡性假设">平衡性假设</h2>
<p>在 PSM 匹配时，用treat变量对控制变量进行Logit回归，得到倾向得分值。倾向得分值最接近的控制组个体即为实验组的配对样本，通过这种方法可以最大程度减少实验组与控制组个体存在的系统性差异，从而减少估计偏误。在进行PSM匹配后的其他估计前比如PSM-DID 估计前，还需进行协变量的平衡性假设检验，即匹配后各变量在实验组和控制组之间是否变得平衡，也就是说实验组和控制组协变量的均值在匹配后是否具有显著差异。如果不存在显著差异，则支持进一步的模型估计。</p>
<p>在平衡性检验之前，我们先使用<code>psmatch2</code>命令进行PSM匹配，处理变量为train，协变量为age、educ、black，结果变量为re78，采用一对一近邻匹配，具体操作如下：</p>
<pre class="line-numbers language-stata" data-language="stata"><code class="language-stata">use ldw_exper.dta,clear<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<pre class="line-numbers language-stata" data-language="stata"><code class="language-stata">findname<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<pre><code>t         educ      hisp      nodegree  re75      u74
age       black     married   re74      re78      u75</code></pre>
<pre class="line-numbers language-stata" data-language="stata"><code class="language-stata">psmatch2 t  age educ black, out(re78) logit ate neighbor(1) common caliper(.05) ties<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<pre><code>Logistic regression                             Number of obs     =        445
                                                LR chi2(3)        =       3.51
                                                Prob &gt; chi2       =     0.3192
Log likelihood = -300.34408                     Pseudo R2         =     0.0058

------------------------------------------------------------------------------
           t |      Coef.   Std. Err.      z    P&gt;|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
         age |   .0143112   .0136229     1.05   0.293    -.0123892    .0410116
        educ |   .0793213   .0546484     1.45   0.147    -.0277876    .1864302
       black |   .0790505   .2625391     0.30   0.763    -.4355167    .5936176
       _cons |  -1.580782   .6798444    -2.33   0.020    -2.913252   -.2483115
------------------------------------------------------------------------------
--------------------------------------------------------------------------------
&gt; --------
        Variable     Sample |    Treated     Controls   Difference         S.E. 
&gt;   T-stat
----------------------------+---------------------------------------------------
&gt; --------
            re78  Unmatched | 6.34914538   4.55480228   1.79434311   .632853552 
&gt;     2.84
                        ATT | 6.26522687   4.18443652   2.08079035   .752125106 
&gt;     2.77
                        ATU | 4.55541071   6.05253804   1.49712733            . 
&gt;        .
                        ATE |                           1.73855158            . 
&gt;        .
----------------------------+---------------------------------------------------
&gt; --------
Note: S.E. does not take into account that the propensity score is estimated.

 psmatch2: |   psmatch2: Common
 Treatment |        support
assignment | Off suppo  On suppor |     Total
-----------+----------------------+----------
 Untreated |         2        258 |       260 
   Treated |         3        182 |       185 
-----------+----------------------+----------
     Total |         5        440 |       445 </code></pre>
<p>PSM 匹配完成之后，我们需要检验匹配后的样本是否满足平衡性假设，即实验组与控制组的匹配协变量是否没有显著性差异，在这里可以使用<code>pstest</code>命令进行检验，具体如下：</p>
<pre class="line-numbers language-stata" data-language="stata"><code class="language-stata">pstest age educ black hisp married , t(t)  <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<pre><code>------------------------------------------------------------------------------
                        |       Mean               |     t-test    |  V(T)/
Variable                | Treated Control    %bias |    t    p&gt;|t| |  V(C)
------------------------+--------------------------+---------------+----------
age                     | 25.527   24.714     11.4 |   1.19  0.234 |  1.24
educ                    | 10.291   10.401     -6.0 |  -0.59  0.557 |  1.60*
black                   | .84066   .87363     -8.9 |  -0.90  0.370 |     .
hisp                    | .06044   .09066    -10.9 |  -1.09  0.277 |     .
married                 | .18681    .1522      9.2 |   0.88  0.380 |     .
------------------------------------------------------------------------------
* if variance ratio outside [0.75; 1.34]

----------------------------------------------------------------------
Ps R2   LR chi2   p&gt;chi2   MeanBias   MedBias      B       R     %Var 
----------------------------------------------------------------------
0.019      9.70    0.084      9.3       9.2      32.4*    2.23*    50
----------------------------------------------------------------------
* if B&gt;25%, R outside [0.5; 2]</code></pre>
<h2 id="选择匹配协变量">选择匹配协变量</h2>
<p>根据t检验结果发现，以上5个协变量在实验组与控制组之间不存在显著性差异。</p>
<p>那么，在进行 PSM 分析之前，应当如何选择匹配协变量，使模型实现最佳的拟合效果呢？今天介绍的 psestimate 命令可以通过比较不同模型的极大似然值，帮助我们选择能实现最佳拟合效果的协变量的一阶和二阶形式。</p>
<p>The <code>psestimate</code> command estimates the propensity score proposed by <a target="_blank" rel="noopener" href="https://www.sci-hub.shop/10.3368/jhr.50.2.373">Imbens and Rubin (2015)</a>. The main purpose of the program is to select a linear or quadratic function of covariates to include in the estimation function of the propensity score.</p>
<h3 id="命令的安装与示例数据导入">命令的安装与示例数据导入</h3>
<p>在Stata命令窗口执行第一行代码即可完成对 <code>psestimate</code> 命令的下载，然后输入第二行命令下载网上示例数据 nswre74.dta（LaLonde, 1986），并执行第三行命令导入数据。</p>
<pre class="line-numbers language-stata" data-language="stata"><code class="language-stata">ssc install psestimate, replace //安装命令<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<pre><code>checking psestimate consistency and verifying not already installed...
all files already exist and are up to date.</code></pre>
<h3 id="命令的语法">命令的语法</h3>
<p>该命令的语法如下：</p>
<pre class="line-numbers language-none"><code class="language-none">psestimate depvar [indepvars] [if] [in] [, options]
options：             
     totry(indepvars)     
     notry(varlist)       
     nolin               
     noquad              
     clinear(real)       
     cquadratic(real)    
     iterate(#)          
     genpscore(newvar)   
     genlor(newvar)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>各个主要选项的含义如下：</p>
<ul>
<li><code>depvar</code>，必选项，填入处理变量（如 treat），即标记是否参与实验的虚拟变量</li>
<li><code>indepvars</code>，可选项，指定基准模型中的协变量</li>
<li><code>totry(indepvars)</code>，可选项，放入供选择的协变量列表，默认为全部</li>
<li><code>notry(varlist)</code>，可选项，指定不包括的协变量列表，默认为没有</li>
<li><code>nolin</code>，可选项，指定不进行一阶多项式的选择</li>
<li><code>noquad</code>，可选项，指定不进行二阶多项式的选择</li>
<li><code>clinear(real)</code>，可选项，指定一阶协变量似然比检验的门槛值，默认值为 1</li>
<li><code>cquadratic(real)</code>，可选项，指定二阶协变量似然比检验的门槛值，默认值是 2.71</li>
<li><code>iterate(#)</code>，可选项，指定在每个 logit 中执行循环的最大值，默认值是 16000</li>
<li><code>genpscore(newvar)</code>，可选项，由于指定程序自动生成的用于记录倾向得分值的新变量的名称</li>
<li><code>genlor(newvar)</code>，可选项，生成对数似然比的新变量的名称</li>
</ul>
<h2 id="命令操作">命令操作</h2>
<p> </p>
<h3 id="命令基本操作">命令基本操作</h3>
<p>下面本文将基于 <code>psestimate</code> 命令的作者提供的数据集 <strong>nswre74.dta</strong> 来简要说明如何使用 <code>psestimate</code> 这一命令来选择能最好拟合处理变量 (treat) 的协变量的一阶及二阶形式。</p>
<p>在这里，我们事先选定教育变量 <strong>ed</strong> 作为基准模型中的一个协变量，意味着 Stata 自动将 <strong>ed</strong> 放入基准模型中。另外，我们将指定 <strong>age</strong>、<strong>black</strong>、<strong>hisp</strong>、<strong>nodeg</strong> 四个变量作为待选协变量。代码如下：</p>
<pre class="line-numbers language-stata" data-language="stata"><code class="language-stata">use "nswre74.dta", clear
psestimate treat ed, totry(age black hisp nodeg)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>​</p>
<pre><code>Selecting first order covariates... (10)
----+--- 1 ---+--- 2 ---+--- 3 ---+--- 4 ---+--- 5 
...s..s..
Selected first order covariates are: nodeg hisp
Selecting second order covariates... (21)
----+--- 1 ---+--- 2 ---+--- 3 ---+--- 4 ---+--- 5 
.....s.....
Selected second order covariates are: c.nodeg#c.ed
Final model is: ed nodeg hisp c.nodeg#c.ed</code></pre>
<p>根据以上结果，可以确定在倾向得分匹配中，我们应该选取的一阶协变量为 <strong>nodeg</strong>、<strong>hisp</strong>，二阶协变量为 <strong>c.nodeg#c.ed</strong>。综上，根据 <code>psestimate</code> 命令的运算结果，我们应该选取 <strong>ed</strong>、<strong>nodeg</strong>、<strong>hisp</strong>、<strong>c.nodeg#c.ed</strong> 等四个变量作为倾向得分匹配的协变量。</p>
<h3 id="提升运算速度">提升运算速度</h3>
<p><code>psestimate</code>命令在运算中会耗费较长时间，而通常来说，该命令在选择协变量的一阶形式时要快于二阶形式的选择，因此，为了加快运算速度，我们可以首先通过加入<code>noquad</code>选项，只对协变量的一阶形式进行筛选，当一阶形式选定后，将其作为解释变量放入基准模型中，然后加入<code>nolin</code> 选项跳过一阶形式筛选步骤，只对协变量的二阶形式进行筛选。具体操作如下。</p>
<p>首先，加入入<code>noquad</code>选项，只筛选协变量的一阶形式，如下：</p>
<pre class="line-numbers language-stata" data-language="stata"><code class="language-stata">use "nswre74.dta", clear
psestimate treat ed, totry(age black hisp nodeg) noquad<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>​</p>
<pre><code>Selecting first order covariates... (10)
----+--- 1 ---+--- 2 ---+--- 3 ---+--- 4 ---+--- 5 
...s..s..
Selected first order covariates are: nodeg hisp
Final model is: ed nodeg hisp</code></pre>
<p>然后，将选定的<strong>ed</strong>、<strong>nodeg</strong>、<strong>hisp</strong>作为解释变量放入基准模型中，加入<code>nolin</code>选项值进行二阶形式的筛选，操作如下：。</p>
<pre class="line-numbers language-stata" data-language="stata"><code class="language-stata">psestimate treat ed nodeg hisp , totry(age black hisp nodeg) nolin<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<pre><code>Selecting second order covariates... (21)
----+--- 1 ---+--- 2 ---+--- 3 ---+--- 4 ---+--- 5 
.....s.....
Selected second order covariates are: c.nodeg#c.ed
Final model is: ed nodeg hisp  c.nodeg#c.ed</code></pre>
<h2 id="psestimate-的核心思想">psestimate 的核心思想</h2>
<p> </p>
<h3 id="协变量一阶形式的选择">协变量一阶形式的选择</h3>
<p>第一步，该程序首先在基准模型（<code>logit treat ed</code>）基础上通过循环分别加入 <code>totry()</code> 中指定的四个变量 <strong>age</strong>、<strong>black</strong>、<strong>hisp</strong>、<strong>nodeg</strong>，进行四次模型估计，如下所示：</p>
<pre class="line-numbers language-none"><code class="language-none">logit treat ed age
logit treat ed black
logit treat ed hisp
logit treat ed nodeg<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>每次估计完成后，它将得到的新的极大似然值与基准模型比较，选择上述四个模型中对数极大似然值 (Log-Likelihood, 简称 LL 值) 最大的模型中的协变量放入基准模型中，除非上述四个模型的极大似然值都低于 <code>clinear(real)</code> 中指定的门槛值。若此处假设为 <strong>nodeg</strong>，则基准模型扩展为 <code>logit treat ed nodeg</code>, 然后第二步，它将估计如下模型：</p>
<pre class="line-numbers language-none"><code class="language-none">logit treat ed nodeg age
logit treat ed nodeg black
logit treat ed nodeg hisp<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>这一步的协变量筛选原则与第一b步相同。可以看出，当供选择的协变量数量为<span class="math inline">\(C\)</span>时，在确定协变量的一阶形式时，该程序理论上会估计<span class="math inline">\(\sum C\)</span> 个 Logit 模型。本例中有 4 个供选择的协变量，则需要估计 10 次（如下括号中所示），该命令选择的协变量一阶形式结果如下：</p>
<pre class="line-numbers language-none"><code class="language-none">Selecting first order covariates... (10)
----+--- 1 ---+--- 2 ---+--- 3 ---+--- 4 ---+--- 5 
...s..s..
Selected first order covariates are: nodeg hisp<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p> </p>
<h3 id="协变量二阶形式的选择">协变量二阶形式的选择</h3>
<p>在协变量二阶形式的选择上，主要分为协变量平方项以及协变量间的交乘项。 如果在一阶形式中只选择了 <strong>a</strong> 这一个协变量，则二阶形式的选择只需要检验 <strong>a^2</strong> 这一变量。但是如果有 <strong>a</strong>、<strong>b</strong> 两个一阶协变量被选择，则二阶形式的选择需要检验 <strong>a<sup>2<strong>、</strong>b</sup>2</strong>、<strong>ab</strong> 三个二阶协变量形式。具体到本例，确定的一阶协变量有 <strong>ed</strong>、<strong>nodeg</strong>、<strong>hisp</strong> 三个，则需要检验的二阶协变量有六个，即 <strong>ed<sup>2<strong>、</strong>nodeg</sup>2</strong>、<strong>hisp^2</strong>、<strong>c.ed#c.nodeg</strong>、<strong>c.ed#c.hisp</strong>、<strong>c.nodeg#c.hisp</strong>，筛选过程与选择协变量一阶形式的方法一致。因此本例中共需估计 即 21 次（如下括号中所示），结果如下所示：</p>
<pre class="line-numbers language-none"><code class="language-none">Selecting second order covariates... (21)
----+--- 1 ---+--- 2 ---+--- 3 ---+--- 4 ---+--- 5 
.....s.....
Selected second order covariates are: c.nodeg#c.ed
Final model is: ed nodeg hisp c.nodeg#c.ed<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p> </p>
<h3 id="流程图展示">流程图展示</h3>
<p>如下流程图可以更加直观地展现<code>psestimate</code>筛选协变量一阶及二阶形式的过程，为简化分析，我们可供选择的协变量为<strong>a</strong>、<strong>b</strong>两个变量，假设各模型的对数极大似然值存在如下大小关系，LL1&gt;LL2&gt; <code>clinear()</code> &gt;LL3,LL4&gt;LL5&gt;LL6&gt; <code>cquadratic()</code> &gt;LL7&gt;LL8。</p>
<figure>
<img src="https://fig-lianxh.oss-cn-shenzhen.aliyuncs.com/17510288-32214398557f861a.png" alt=""><figcaption>图1.流程图</figcaption>
</figure>
<h2 id="psm估计的完整流程示例">PSM估计的完整流程示例</h2>
<p> </p>
<h3 id="psestimate-筛选匹配变量的一阶二阶形式">psestimate 筛选匹配变量的一阶、二阶形式</h3>
<p>第一步，使用<code>psestimate</code>筛选匹配变量</p>
<pre class="line-numbers language-stata" data-language="stata"><code class="language-stata">use "nswre74.dta", clear
psestimate treat ed, totry(age black hisp nodeg) <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>​</p>
<pre><code>Selecting first order covariates... (10)
----+--- 1 ---+--- 2 ---+--- 3 ---+--- 4 ---+--- 5 
...s..s..
Selected first order covariates are: nodeg hisp
Selecting second order covariates... (21)
----+--- 1 ---+--- 2 ---+--- 3 ---+--- 4 ---+--- 5 
.....s.....
Selected second order covariates are: c.nodeg#c.ed
Final model is: ed nodeg hisp c.nodeg#c.ed</code></pre>
<p>最终选择的匹配变量为<strong>ed</strong>、<strong>nodeg</strong>、<strong>hisp</strong>、<strong>c.nodeg#c.ed</strong></p>
<h3 id="psmatch2-基于筛选出的匹配变量进行psm匹配">psmatch2 基于筛选出的匹配变量进行PSM匹配</h3>
<p>基于上述匹配变量进行PSM匹配：</p>
<pre class="line-numbers language-stata" data-language="stata"><code class="language-stata">psmatch2 treat ed nodeg hisp c.nodeg#c.ed, logit ate neighbor(1) common caliper(.05) ties<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<pre><code>Logistic regression                             Number of obs     =        445
                                                LR chi2(4)        =      17.03
                                                Prob &gt; chi2       =     0.0019
Log likelihood = -293.58317                     Pseudo R2         =     0.0282

------------------------------------------------------------------------------
       treat |      Coef.   Std. Err.      z    P&gt;|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
          ed |   .5093428   .3298117     1.54   0.123    -.1370762    1.155762
       nodeg |   6.506319   4.112404     1.58   0.114    -1.553845    14.56648
        hisp |  -.5954105   .3754841    -1.59   0.113    -1.331346    .1405248
             |
c.nodeg#c.ed |  -.6068825   .3375387    -1.80   0.072    -1.268446    .0546813
             |
       _cons |  -6.021438    4.05441    -1.49   0.138    -13.96794    1.925059
------------------------------------------------------------------------------</code></pre>
<h3 id="pstest-进行平衡性假设检验">pstest 进行平衡性假设检验</h3>
<pre class="line-numbers language-stata" data-language="stata"><code class="language-stata">pstest ed nodeg hisp c.nodeg#c.ed, t(treat)  <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<pre><code>------------------------------------------------------------------------------
                        |       Mean               |     t-test    |  V(T)/
Variable                | Treated Control    %bias |    t    p&gt;|t| |  V(C)
------------------------+--------------------------+---------------+----------
ed                      |  10.29   10.464     -9.6 |  -0.91  0.363 |  1.28
nodeg                   | .71585   .69399      5.3 |   0.46  0.648 |     .
hisp                    | .06011   .06011     -0.0 |  -0.00  1.000 |     .
c.nodeg#c.ed            | 6.7814    6.694      2.1 |   0.18  0.854 |  0.96
------------------------------------------------------------------------------
* if variance ratio outside [0.75; 1.34]

----------------------------------------------------------------------
Ps R2   LR chi2   p&gt;chi2   MeanBias   MedBias      B       R     %Var 
----------------------------------------------------------------------
0.002      1.09    0.896      4.2       3.7      10.8    1.43       0
----------------------------------------------------------------------
* if B&gt;25%, R outside [0.5; 2]</code></pre>
<h3 id="psgraph-绘图直观呈现各匹配变量的平衡性状况">psgraph 绘图直观呈现各匹配变量的平衡性状况</h3>
<pre class="line-numbers language-stata" data-language="stata"><code class="language-stata">psgraph<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<blockquote>
<p>图中也可以直观看出，实验组与控制组的倾向得分值分布大致平衡。</p>
</blockquote>
<h3 id="参考文献">参考文献</h3>
<ol type="1">
<li>Dehejia, Rajeev H. and Sadek Wahba. 1999. "Causal Effects in Nonexperimental Studies". Journal of the American Statistical Association 94(448): 1053-1062.</li>
<li>Imbens, Guido W. and Donald B. Rubin. 2015. Causal Inference in Statistics, Social, and Biomedical Sciences. New York: Cambridge University Press.</li>
<li>Imbens, Guido W. 2015. “Matching Methods in Practice: Three Examples.” Journal of Human Resources 50 (2): 373–419. [<a target="_blank" rel="noopener" href="https://www.sci-hub.shop/10.3368/jhr.50.2.373">PDF1]</a>， [<a target="_blank" rel="noopener" href="https://pdfs.semanticscholar.org/975a/9905a091498d9878ebcd42cb01eff7e02e8d.pdf?_ga=2.17924345.130556769.1557067739-533034284.1555775018">PDF2-wp]</a></li>
<li>LaLonde, Robert J. 1986. “Evaluating the Econometric Evaluations of Training Programs with Experimental Data.” The American Economic Review 76 (4): 604–20. [<a target="_blank" rel="noopener" href="http://www.uh.edu/~adkugler/Lalonde.pdf">PDF]</a></li>
</ol>
<h1 id="psm-did在stata中的实现过程代码">PSM-DID在Stata中的实现过程代码</h1>
<h2 id="数据准备">数据准备</h2>
<pre class="line-numbers language-stata" data-language="stata"><code class="language-stata">use nlswork.dta,clear<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<pre><code>(National Longitudinal Survey.  Young Women 14-26 years of age in 1968)</code></pre>
<pre class="line-numbers language-stata" data-language="stata"><code class="language-stata">xtset idcode year, delta(1)  //设置面板
xtdescribe   //描述一下这个面板数据情况<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<pre><code>       panel variable:  idcode (unbalanced)
        time variable:  year, 68 to 88, but with gaps
                delta:  1 unit</code></pre>
<p>​</p>
<pre><code>  idcode:  1, 2, ..., 5159                                   n =       4711
    year:  68, 69, ..., 88                                   T =         15
           Delta(year) = 1 unit
           Span(year)  = 21 periods
           (idcode*year uniquely identifies each observation)

Distribution of T_i:   min      5%     25%       50%       75%     95%     max
                         1       1       3         5         9      13      15

     Freq.  Percent    Cum. |  Pattern
 ---------------------------+-----------------------
      136      2.89    2.89 |  1....................
      114      2.42    5.31 |  ....................1
       89      1.89    7.20 |  .................1.11
       87      1.85    9.04 |  ...................11
       86      1.83   10.87 |  111111.1.11.1.11.1.11
       61      1.29   12.16 |  ..............11.1.11
       56      1.19   13.35 |  11...................
       54      1.15   14.50 |  ...............1.1.11
       54      1.15   15.64 |  .......1.11.1.11.1.11
     3974     84.36  100.00 | (other patterns)
 ---------------------------+-----------------------
     4711    100.00         |  XXXXXX.X.XX.X.XX.X.XX</code></pre>
<pre class="line-numbers language-stata" data-language="stata"><code class="language-stata">gen age2= age^2
gen ttl_exp2=ttl_exp^2
gen tenure2=tenure^2<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<pre><code>(24 missing values generated)</code></pre>
<p>​</p>
<pre><code>(433 missing values generated)</code></pre>
<pre class="line-numbers language-stata" data-language="stata"><code class="language-stata">global xlist "grade age age2 ttl_exp ttl_exp2 tenure tenure2 not_smsa south race"
sum ln_w $xlist  //统计描述相关变量<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>​<br>
​</p>
<pre><code>    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
     ln_wage |     28,534    1.674907    .4780935          0   5.263916
       grade |     28,532    12.53259    2.323905          0         18
         age |     28,510    29.04511    6.700584         14         46
        age2 |     28,510    888.5145    403.6554        196       2116
     ttl_exp |     28,534    6.215316    4.652117          0   28.88461
-------------+---------------------------------------------------------
    ttl_exp2 |     28,534    60.27159    80.33339          0    834.321
      tenure |     28,101    3.123836    3.751409          0   25.91667
     tenure2 |     28,101    23.83092    54.75053          0   671.6736
    not_smsa |     28,526    .2824441    .4501961          0          1
       south |     28,526    .4095562    .4917605          0          1
-------------+---------------------------------------------------------
        race |     28,534    1.303392    .4822773          1          3</code></pre>
<h2 id="did方法">DID方法</h2>
<pre class="line-numbers language-stata" data-language="stata"><code class="language-stata">gen time = (year &gt;= 77) &amp; !missing(year)  //政策执行时间为1977年
gen treated = (idcode &gt;2000)&amp;!missing(idcode) //政策执行地方为idcode大于2000的地方
gen did = time*treated  //这就是需要估计的DID，也就所交叉项<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-stata" data-language="stata"><code class="language-stata">reg ln_w did time treated $xlist //这就是一个OLS回归，也可以用diff命令<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<pre><code>      Source |       SS           df       MS      Number of obs   =    28,091
-------------+----------------------------------   F(13, 28077)    =   1295.76
       Model |  2405.08413        13  185.006471   Prob &gt; F        =    0.0000
    Residual |  4008.77975    28,077  .142778066   R-squared       =    0.3750
-------------+----------------------------------   Adj R-squared   =    0.3747
       Total |  6413.86388    28,090  .228332641   Root MSE        =    .37786

------------------------------------------------------------------------------
     ln_wage |      Coef.   Std. Err.      t    P&gt;|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
         did |   .0124603   .0094099     1.32   0.185    -.0059836    .0309042
        time |  -.0694754   .0097324    -7.14   0.000    -.0885513   -.0503996
     treated |  -.0142815   .0078374    -1.82   0.068    -.0296431    .0010801
       grade |   .0633445   .0010293    61.54   0.000      .061327     .065362
         age |   .0484968   .0036834    13.17   0.000     .0412771    .0557165
        age2 |  -.0008259   .0000583   -14.18   0.000    -.0009401   -.0007117
     ttl_exp |   .0250849    .002395    10.47   0.000     .0203906    .0297793
    ttl_exp2 |   .0002872   .0001266     2.27   0.023      .000039    .0005353
      tenure |   .0460783    .001968    23.41   0.000     .0422209    .0499356
     tenure2 |  -.0019604   .0001341   -14.62   0.000    -.0022233   -.0016976
    not_smsa |  -.1686808   .0051713   -32.62   0.000    -.1788169   -.1585447
       south |  -.1017625   .0055672   -18.28   0.000    -.1126745   -.0908504
        race |  -.0528909   .0049329   -10.72   0.000    -.0625597   -.0432221
       _cons |   .1400083   .0535917     2.61   0.009     .0349661    .2450506
------------------------------------------------------------------------------</code></pre>
<pre class="line-numbers language-stata" data-language="stata"><code class="language-stata">xtreg ln_w did time treated $xlist i.year, fe //也可以这去做，会省略掉一个虚拟变量<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<pre><code>note: treated omitted because of collinearity
note: grade omitted because of collinearity
note: race omitted because of collinearity
note: 88.year omitted because of collinearity

Fixed-effects (within) regression               Number of obs     =     28,091
Group variable: idcode                          Number of groups  =      4,697

R-sq:                                           Obs per group:
     within  = 0.1781                                         min =          1
     between = 0.3576                                         avg =        6.0
     overall = 0.2666                                         max =         15

                                                F(23,23371)       =     220.25
corr(u_i, Xb)  = 0.1840                         Prob &gt; F          =     0.0000

------------------------------------------------------------------------------
     ln_wage |      Coef.   Std. Err.      t    P&gt;|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
         did |    .019761    .008746     2.26   0.024     .0026182    .0369037
        time |  -.3296955   .2012367    -1.64   0.101    -.7241326    .0647416
     treated |          0  (omitted)
       grade |          0  (omitted)
         age |   .0665613   .0105138     6.33   0.000     .0459536    .0871689
        age2 |  -.0009369   .0000616   -15.20   0.000    -.0010577    -.000816
     ttl_exp |   .0392161    .003072    12.77   0.000     .0331947    .0452375
    ttl_exp2 |  -.0001047   .0001352    -0.77   0.439    -.0003697    .0001603
      tenure |   .0338566   .0018579    18.22   0.000     .0302151    .0374981
     tenure2 |  -.0018164    .000126   -14.42   0.000    -.0020633   -.0015695
    not_smsa |   -.086641   .0095117    -9.11   0.000    -.1052846   -.0679974
       south |  -.0597302   .0109246    -5.47   0.000    -.0811431   -.0383173
        race |          0  (omitted)
             |
        year |
         69  |   .0423343    .015528     2.73   0.006     .0118984    .0727702
         70  |  -.0339863    .022938    -1.48   0.138    -.0789464    .0109737
         71  |  -.0299658   .0318704    -0.94   0.347     -.092434    .0325023
         72  |  -.0584678   .0412716    -1.42   0.157    -.1393627    .0224272
         73  |  -.0961513   .0508379    -1.89   0.059     -.195797    .0034943
         75  |  -.1513149   .0698104    -2.17   0.030    -.2881479   -.0144818
         77  |   .1558488   .1129486     1.38   0.168    -.0655379    .3772354
         78  |   .1417381   .1027217     1.38   0.168    -.0596031    .3430793
         80  |   .0826885   .0834407     0.99   0.322    -.0808607    .2462377
         82  |   .0268096   .0638067     0.42   0.674    -.0982557     .151875
         83  |   .0103961    .054166     0.19   0.848    -.0957727     .116565
         85  |    .007777   .0347411     0.22   0.823    -.0603178    .0758717
         87  |  -.0223798   .0162763    -1.37   0.169    -.0542825    .0095229
         88  |          0  (omitted)
             |
       _cons |   .5038214   .1945871     2.59   0.010     .1224179    .8852249
-------------+----------------------------------------------------------------
     sigma_u |   .3532234
     sigma_e |   .2898202
         rho |  .59764928   (fraction of variance due to u_i)
------------------------------------------------------------------------------
F test that all u_i=0: F(4696, 23371) = 6.58                 Prob &gt; F = 0.0000</code></pre>
<h2 id="psm-did方法">PSM-DID方法</h2>
<h3 id="psm的部分">PSM的部分</h3>
<pre class="line-numbers language-stata" data-language="stata"><code class="language-stata">set seed 0001 //定义种子
gen tmp = runiform() //生成随机数
sort tmp //把数据库随机整理<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-stata" data-language="stata"><code class="language-stata">psmatch2 treated $xlist, out(ln_w) logit ate neighbor(1) common caliper(.05) ties //通过近邻匹配，这里可以要outcome，也可以不要它<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<pre><code>Logistic regression                             Number of obs     =     28,091
                                                LR chi2(10)       =   10093.80
                                                Prob &gt; chi2       =     0.0000
Log likelihood =  -13636.63                     Pseudo R2         =     0.2701

------------------------------------------------------------------------------
     treated |      Coef.   Std. Err.      z    P&gt;|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
       grade |  -.0342869   .0070082    -4.89   0.000    -.0480227   -.0205511
         age |   .1726049   .0227237     7.60   0.000     .1280673    .2171424
        age2 |  -.0026816   .0003693    -7.26   0.000    -.0034054   -.0019577
     ttl_exp |  -.0681925   .0155242    -4.39   0.000    -.0986193   -.0377657
    ttl_exp2 |   .0040423   .0008363     4.83   0.000     .0024031    .0056815
      tenure |  -.0138884   .0128354    -1.08   0.279    -.0390453    .0112686
     tenure2 |   .0002263   .0008671     0.26   0.794    -.0014733    .0019259
    not_smsa |   .4024444   .0355904    11.31   0.000     .3326885    .4722002
       south |   2.865226   .0409688    69.94   0.000     2.784928    2.945523
        race |   .7655284    .034012    22.51   0.000     .6988662    .8321907
       _cons |  -3.400584   .3254663   -10.45   0.000    -4.038487   -2.762682
------------------------------------------------------------------------------
--------------------------------------------------------------------------------
&gt; --------
        Variable     Sample |    Treated     Controls   Difference         S.E. 
&gt;   T-stat
----------------------------+---------------------------------------------------
&gt; --------
         ln_wage  Unmatched | 1.62754443   1.75722818  -.129683748   .005816206 
&gt;   -22.30
                        ATT | 1.62798811   1.70873922  -.080751107   .021132148 
&gt;    -3.82
                        ATU | 1.75707925   1.75230645  -.004772802            . 
&gt;        .
                        ATE |                          -.051698588            . 
&gt;        .
----------------------------+---------------------------------------------------
&gt; --------
Note: S.E. does not take into account that the propensity score is estimated.

 psmatch2: |   psmatch2: Common
 Treatment |        support
assignment | Off suppo  On suppor |     Total
-----------+----------------------+----------
 Untreated |         2     10,733 |    10,735 
   Treated |        20     17,336 |    17,356 
-----------+----------------------+----------
     Total |        22     28,069 |    28,091 </code></pre>
<pre class="line-numbers language-stata" data-language="stata"><code class="language-stata">pstest $xlist, both graph  //检验协变量在处理组与控制组之间是否平衡<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<pre><code>--------------------------------------------------------------------------------
&gt; --------
                Unmatched |       Mean               %reduct |     t-test    |  
&gt; V(T)/
Variable          Matched | Treated Control    %bias  |bias| |    t    p&gt;|t| |  
&gt; V(C)
--------------------------+----------------------------------+---------------+--
&gt; --------
grade                  U  | 12.341   12.853    -22.3         | -18.01  0.000 |  
&gt; 1.18*
                       M  | 12.348   12.645    -12.9    42.1 | -12.03  0.000 |  
&gt; 1.15*
                          |                                  |               |
age                    U  | 29.223   28.848      5.6         |   4.56  0.000 |  
&gt; 0.94*
                       M  | 29.216   30.875    -24.7  -342.5 | -23.65  0.000 |  
&gt; 1.05*
                          |                                  |               |
age2                   U  |  897.8   878.68      4.7         |   3.86  0.000 |  
&gt; 0.95*
                       M  | 897.33   994.81    -24.1  -409.7 | -22.80  0.000 |  
&gt; 1.01
                          |                                  |               |
ttl_exp                U  | 6.2403   6.2447     -0.1         |  -0.08  0.938 |  
&gt; 1.05*
                       M  | 6.2334   6.9942    -16.4-17031.2 | -14.80  0.000 |  
&gt; 0.92*
                          |                                  |               |
ttl_exp2               U  | 61.008   60.008      1.2         |   1.01  0.312 |  
&gt; 1.03
                       M  | 60.849   72.756    -14.8 -1090.6 | -12.91  0.000 |  
&gt; 0.79*
                          |                                  |               |
tenure                 U  | 3.0891   3.1782     -2.4         |  -1.93  0.053 |  
&gt; 0.96*
                       M  | 3.0899   2.9777      3.0   -25.9 |   2.87  0.004 |  
&gt; 1.10*
                          |                                  |               |
tenure2                U  |  23.41   24.482     -1.9         |  -1.60  0.110 |  
&gt; 0.90*
                       M  | 23.423   21.518      3.5   -77.7 |   3.41  0.001 |  
&gt; 1.14*
                          |                                  |               |
not_smsa               U  | .32945   .20689     27.9         |  22.36  0.000 |  
&gt;    .
                       M  | .32897   .32066      1.9    93.2 |   1.65  0.099 |  
&gt;    .
                          |                                  |               |
south                  U  |   .618   .07219    140.2         | 107.35  0.000 |  
&gt;    .
                       M  | .61756   .61802     -0.1    99.9 |  -0.09  0.930 |  
&gt;    .
                          |                                  |               |
race                   U  | 1.3912   1.1631     50.3         |  39.53  0.000 |  
&gt; 1.91*
                       M  | 1.3896   1.3763      2.9    94.2 |   2.43  0.015 |  
&gt; 1.05*
                          |                                  |               |
--------------------------------------------------------------------------------
&gt; --------
* if variance ratio outside [0.97; 1.03] for U and [0.97; 1.03] for M

--------------------------------------------------------------------------------
&gt; ---
 Sample    | Ps R2   LR chi2   p&gt;chi2   MeanBias   MedBias      B      R     %Va
&gt; r
-----------+--------------------------------------------------------------------
&gt; ---
 Unmatched | 0.272  10149.10    0.000     25.7       5.2     145.8*   3.70*    8
&gt; 8
 Matched   | 0.019    932.83    0.000     10.4       8.2      33.1*   1.16     8
&gt; 8
--------------------------------------------------------------------------------
&gt; ---
* if B&gt;25%, R outside [0.5; 2]</code></pre>
<p><img src="https://gitee.com/shao818/Figure/raw/master/null/Graph111.png"></p>
<p>psgraph 绘图直观呈现各匹配变量的平衡性状况</p>
<p><img src="https://gitee.com/shao818/Figure/raw/master/null/Graph4444.png"></p>
<pre class="line-numbers language-stata" data-language="stata"><code class="language-stata">gen common=_support
drop if common == 0  //去掉不满足共同区域假定的观测值
*drop _weight ==0  //也有情况是把没有匹配的直接删除<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<pre><code>(443 missing values generated)

(22 observations deleted)</code></pre>
<h3 id="did的部分">DID的部分</h3>
<pre class="line-numbers language-stata" data-language="stata"><code class="language-stata">reg ln_w did time treated $xlist <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<pre><code>      Source |       SS           df       MS      Number of obs   =    28,069
-------------+----------------------------------   F(13, 28055)    =   1294.85
       Model |  2402.32966        13  184.794589   Prob &gt; F        =    0.0000
    Residual |   4003.8761    28,055  .142715241   R-squared       =    0.3750
-------------+----------------------------------   Adj R-squared   =    0.3747
       Total |  6406.20576    28,068  .228238769   Root MSE        =    .37778

------------------------------------------------------------------------------
     ln_wage |      Coef.   Std. Err.      t    P&gt;|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
         did |   .0130378   .0094101     1.39   0.166    -.0054064    .0314821
        time |   -.069613   .0097317    -7.15   0.000    -.0886876   -.0505384
     treated |  -.0145157    .007837    -1.85   0.064    -.0298765    .0008452
       grade |   .0635306   .0010326    61.53   0.000     .0615067    .0655545
         age |   .0487295   .0036856    13.22   0.000     .0415054    .0559535
        age2 |  -.0008306   .0000583   -14.24   0.000    -.0009449   -.0007163
     ttl_exp |   .0246821   .0023991    10.29   0.000     .0199798    .0293843
    ttl_exp2 |   .0003217   .0001271     2.53   0.011     .0000726    .0005708
      tenure |   .0461767   .0019693    23.45   0.000     .0423168    .0500365
     tenure2 |  -.0019786   .0001343   -14.73   0.000    -.0022419   -.0017154
    not_smsa |  -.1681968   .0051738   -32.51   0.000    -.1783376    -.158056
       south |   -.101765   .0055661   -18.28   0.000    -.1126748   -.0908551
        race |  -.0534454   .0049452   -10.81   0.000    -.0631381   -.0437526
       _cons |   .1361316   .0536086     2.54   0.011     .0310562    .2412069
------------------------------------------------------------------------------</code></pre>
<pre class="line-numbers language-stata" data-language="stata"><code class="language-stata">xtreg ln_w did time treated $xlist i.year, fe<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<pre><code>note: treated omitted because of collinearity
note: grade omitted because of collinearity
note: race omitted because of collinearity
note: 88.year omitted because of collinearity

Fixed-effects (within) regression               Number of obs     =     28,069
Group variable: idcode                          Number of groups  =      4,696

R-sq:                                           Obs per group:
     within  = 0.1782                                         min =          1
     between = 0.3585                                         avg =        6.0
     overall = 0.2678                                         max =         15

                                                F(23,23350)       =     220.19
corr(u_i, Xb)  = 0.1861                         Prob &gt; F          =     0.0000

------------------------------------------------------------------------------
     ln_wage |      Coef.   Std. Err.      t    P&gt;|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
         did |   .0199922   .0087501     2.28   0.022     .0028414     .037143
        time |  -.3259785   .2014472    -1.62   0.106    -.7208281    .0688712
     treated |          0  (omitted)
       grade |          0  (omitted)
         age |   .0664258   .0105214     6.31   0.000     .0458031    .0870485
        age2 |  -.0009367   .0000617   -15.18   0.000    -.0010576   -.0008158
     ttl_exp |   .0388635   .0030813    12.61   0.000     .0328238    .0449031
    ttl_exp2 |  -.0000845   .0001359    -0.62   0.534    -.0003508    .0001819
      tenure |   .0339768   .0018608    18.26   0.000     .0303295    .0376241
     tenure2 |  -.0018292   .0001263   -14.48   0.000    -.0020768   -.0015817
    not_smsa |  -.0865921   .0095179    -9.10   0.000    -.1052478   -.0679365
       south |  -.0600416   .0109379    -5.49   0.000    -.0814807   -.0386026
        race |          0  (omitted)
             |
        year |
         69  |   .0425357   .0155411     2.74   0.006     .0120741    .0729974
         70  |  -.0332855   .0229601    -1.45   0.147    -.0782887    .0117178
         71  |  -.0290703    .031901    -0.91   0.362    -.0915985    .0334578
         72  |  -.0573452   .0413132    -1.39   0.165    -.1383217    .0236314
         73  |  -.0947357   .0508901    -1.86   0.063    -.1944837    .0050123
         75  |  -.1496357   .0698826    -2.14   0.032    -.2866102   -.0126612
         77  |   .1540973   .1130656     1.36   0.173    -.0675187    .3757134
         78  |    .140131   .1028285     1.36   0.173    -.0614196    .3416817
         80  |    .081445   .0835287     0.98   0.330    -.0822767    .2451668
         82  |   .0260429   .0638735     0.41   0.683    -.0991533     .151239
         83  |   .0097373   .0542219     0.18   0.857    -.0965412    .1160159
         85  |    .007336   .0347776     0.21   0.833    -.0608304    .0755023
         87  |  -.0225526   .0162929    -1.38   0.166    -.0544878    .0093826
         88  |          0  (omitted)
             |
       _cons |   .5068104   .1947252     2.60   0.009     .1251361    .8884847
-------------+----------------------------------------------------------------
     sigma_u |   .3531224
     sigma_e |  .28988636
         rho |  .59740195   (fraction of variance due to u_i)
------------------------------------------------------------------------------
F test that all u_i=0: F(4695, 23350) = 6.56                 Prob &gt; F = 0.0000</code></pre>
</font></font>
                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">王芍</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://wangshao0818.com/posts/2474087705/">https://wangshao0818.com/posts/2474087705/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="/about" target="_blank">王芍</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/%E8%AE%A1%E9%87%8F%E7%BB%8F%E6%B5%8E%E5%AD%A6/">
                                    <span class="chip bg-color">计量经济学</span>
                                </a>
                            
                                <a href="/tags/PSM/">
                                    <span class="chip bg-color">PSM</span>
                                </a>
                            
                                <a href="/tags/%E5%80%BE%E5%90%91%E5%BE%97%E5%88%86%E5%8C%B9%E9%85%8D%E6%B3%95/">
                                    <span class="chip bg-color">倾向得分匹配法</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.4rem;
        line-height: 38px;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>

            
        </div>
    </div>

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="far fa-dot-circle"></i>&nbsp;本篇
            </div>
            <div class="card">
                <a href="/posts/2474087705/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/8.jpg" class="responsive-img" alt="倾向得分匹配法（PSM）">
                        
                        <span class="card-title">倾向得分匹配法（PSM）</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2020-12-06
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E8%AE%A1%E9%87%8F%E7%BB%8F%E6%B5%8E%E5%AD%A6/" class="post-category">
                                    计量经济学
                                </a>
                            
                            
                        </span>
                    </div>
                </div>

                
                <div class="card-action article-tags">
                    
                    <a href="/tags/%E8%AE%A1%E9%87%8F%E7%BB%8F%E6%B5%8E%E5%AD%A6/">
                        <span class="chip bg-color">计量经济学</span>
                    </a>
                    
                    <a href="/tags/PSM/">
                        <span class="chip bg-color">PSM</span>
                    </a>
                    
                    <a href="/tags/%E5%80%BE%E5%90%91%E5%BE%97%E5%88%86%E5%8C%B9%E9%85%8D%E6%B3%95/">
                        <span class="chip bg-color">倾向得分匹配法</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/posts/734154334/">
                    <div class="card-image">
                        
                        <img src="https://gitee.com/shao818/Figure/raw/master/null/data-science.png" class="responsive-img" alt="数据科学">
                        
                        <span class="card-title">数据科学</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2020-12-03
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E6%95%B0%E6%8D%AE%E7%A7%91%E5%AD%A6/" class="post-category">
                                    数据科学
                                </a>
                            
                            <a href="/categories/%E6%95%B0%E6%8D%AE%E7%A7%91%E5%AD%A6/R%E8%AF%AD%E8%A8%80/" class="post-category">
                                    R语言
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/%E6%95%B0%E6%8D%AE%E7%A7%91%E5%AD%A6/">
                        <span class="chip bg-color">数据科学</span>
                    </a>
                    
                    <a href="/tags/R%E8%AF%AD%E8%A8%80/">
                        <span class="chip bg-color">R语言</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    
    <div class="container row center-align" style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2019-2020</span>
            
            <span id="year">2019</span>
            <a href="/about" target="_blank">王芍</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
            &nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span
                class="white-color">50.9k</span>&nbsp;字
            
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;次
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;人
            </span>
            
            <br>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/Shao818" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:772722605@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=772722605" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 772722605" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>













    <a href="https://github.com/Shao818" class="tooltipped" target="_blank" data-tooltip="关注我的CSDN: https://github.com/Shao818" data-position="top" data-delay="50">
        <i class="fab fa-csdn">C</i>
    </a>




    <a href="https://www.cnblogs.com/shao818/" class="tooltipped" target="_blank" data-tooltip="关注我的博客园: https://www.cnblogs.com/shao818/" data-position="top" data-delay="50">
        <i class="fab fa-juejin">博</i>
    </a>


    <a href="https://gitee.com/shao818/Figure/raw/master/null/微信图片_20201130214839.jpg" class="tooltipped" target="_blank" data-tooltip="微信联系我: https://gitee.com/shao818/Figure/raw/master/null/微信图片_20201130214839.jpg" data-position="top" data-delay="50">
        <i class="fab fa-weixin"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/js/FunnyTitle.js"></script>
    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

	
    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
